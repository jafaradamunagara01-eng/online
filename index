Logo
JR NAGARA ONLINE TEST UTME PRACTICE
Professional CBT Platform with AI-Powered Monitoring and Real-time Results.

Admin Portal
Manage tests, students, and live monitoring.

Register
New candidate registration and slip printing.

Student Portal
Take examinations with AI verification.

Check Results
View and print your performance slips.

© 2026 JR NAGARA ONLINE TEST. All rights reserved. No remixing or copying allowed.
// Admin Dashboard Components

const { useState, useEffect, useRef } = React;

function Login({ onLogin, portalSettings }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        // Hardcoded for demo; in production use robust auth
        if (email === 'jrnagara@gmail.com' && password === '@jafar123') {
            onLogin();
        } else {
            setError('Invalid credentials');
        }
    };

    return (
        <div style={{"paddingTop":"16px","paddingRight":"16px","paddingBottom":"82px","paddingLeft":"17px","marginTop":"0px","marginRight":"78px","marginBottom":"0px","marginLeft":"100px","fontSize":"16px","color":"#ffffff","backgroundColor":"#ffffff","textAlign":"start","fontWeight":"400","objectFit":"fill","display":"flex","position":"relative","top":"0px","left":"0px","right":"0px","bottom":"0px"}} data-vh-processed="screen" className="flex items-center justify-center bg-[#0f172a] p-4 relative overflow-hidden">
             {/* Badge Background Watermark */}
             <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                <img src={portalSettings.logo || "https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg"} className="w-[80%] h-[80%] object-contain" />
            </div>

            <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative z-10">
                <div className="text-center mb-6">
                    <div className="w-20 h-20 mx-auto mb-4 rounded-full overflow-hidden border-4 border-gray-100">
                         <img src={portalSettings.logo || "https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg"} className="w-full h-full object-cover" />
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900">{portalSettings.name || "Admin Portal"}</h1>
                    <p className="text-gray-500">Secure Access Required</p>
                </div>
                {error && <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm text-center">{error}</div>}
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium mb-1">Email Address</label>
                        <input 
                            type="email" 
                            className="w-full p-3 border rounded-lg"
                            value={email}
                            onChange={e => setEmail(e.target.value)}
                            placeholder="admin@example.com"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-1">Password</label>
                        <input 
                            type="password" 
                            className="w-full p-3 border rounded-lg"
                            value={password}
                            onChange={e => setPassword(e.target.value)}
                            placeholder="••••••••"
                        />
                    </div>
                    <button className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold hover:bg-blue-800 transition-colors">
                        Login to Dashboard
                    </button>
                </form>
                <div className="mt-6 text-center">
                    <a href="index.html" className="text-sm text-gray-400 hover:text-gray-600">Back to Home</a>
                </div>
            </div>
        </div>
    );
}

function Sidebar({ activeTab, onTabChange, onLogout, portalSettings }) {
    const menuItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'icon-layout-dashboard' },
        { id: 'tests', label: 'Test Management', icon: 'icon-file-text' },
        { id: 'students', label: 'Students', icon: 'icon-users' },
        { id: 'monitor', label: 'Live Monitor', icon: 'icon-video' },
        { id: 'results', label: 'Results & Analytics', icon: 'icon-chart-bar' },
        { id: 'settings', label: 'Portal Settings', icon: 'icon-settings' },
    ];

    return (
        <div className="w-64 bg-[#0f172a] text-white min-h-screen flex flex-col fixed left-0 top-0 overflow-y-auto z-20">
            <div className="p-6 border-b border-gray-700 flex items-center gap-3">
                <div className="w-10 h-10 rounded-full overflow-hidden bg-white flex-shrink-0">
                    <img src={portalSettings.logo || "https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg"} className="w-full h-full object-cover" />
                </div>
                <div className="overflow-hidden">
                    <h1 className="font-bold tracking-wider text-sm truncate">{portalSettings.shortName || "JR NAGARA"}</h1>
                    <p className="text-[10px] text-gray-400">ADMINISTRATOR</p>
                </div>
            </div>
            <nav className="flex-1 p-4 space-y-2">
                {menuItems.map(item => (
                    <button
                        key={item.id}
                        onClick={() => onTabChange(item.id)}
                        className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${
                            activeTab === item.id 
                            ? 'bg-blue-600 text-white' 
                            : 'text-gray-400 hover:bg-gray-800 hover:text-white'
                        }`}
                    >
                        <div className={`${item.icon} text-xl`}></div>
                        <span>{item.label}</span>
                    </button>
                ))}
            </nav>
            <div className="p-4 border-t border-gray-700">
                <button onClick={onLogout} className="flex items-center space-x-2 text-gray-400 hover:text-white transition-colors w-full px-4 py-2">
                    <div className="icon-log-out"></div>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    );
}

function SettingsManager({ settings, onUpdate }) {
    const [formData, setFormData] = useState({
        portal_name: settings.portal_name || 'JR NAGARA ONLINE TEST',
        portal_short_name: settings.portal_short_name || 'JR NAGARA',
        portal_logo: settings.portal_logo || 'https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg'
    });

    const handleSave = async () => {
        await window.JRStorage.setSetting('portal_name', formData.portal_name);
        await window.JRStorage.setSetting('portal_short_name', formData.portal_short_name);
        await window.JRStorage.setSetting('portal_logo', formData.portal_logo);
        onUpdate();
        alert("Settings Saved!");
    };

    return (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl">
            <h2 className="text-xl font-bold mb-6">Portal Customization</h2>
            <div className="space-y-4">
                <div>
                    <label className="block text-sm font-medium mb-1">Portal Name (Full)</label>
                    <input 
                        className="w-full p-2 border rounded" 
                        value={formData.portal_name}
                        onChange={e => setFormData({...formData, portal_name: e.target.value})}
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium mb-1">Short Name / Brand</label>
                    <input 
                        className="w-full p-2 border rounded" 
                        value={formData.portal_short_name}
                        onChange={e => setFormData({...formData, portal_short_name: e.target.value})}
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium mb-1">Logo URL</label>
                    <input 
                        className="w-full p-2 border rounded" 
                        value={formData.portal_logo}
                        onChange={e => setFormData({...formData, portal_logo: e.target.value})}
                    />
                    <div className="mt-2 text-xs text-gray-500">Preview:</div>
                    <img src={formData.portal_logo} className="h-16 mt-1 object-contain border rounded p-1" />
                </div>
                <button onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded font-bold">
                    Save Changes
                </button>
            </div>
        </div>
    );
}

function Dashboard({ setActiveTab }) {
    const [stats, setStats] = useState({ tests: 0, students: 0, active: 0, results: 0 });
    const [regOpen, setRegOpen] = useState(true);
    const [resultsOpen, setResultsOpen] = useState(true);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        loadStats();
    }, []);

    const loadStats = async () => {
        try {
            setLoading(true);
            const tests = await window.JRStorage.getTests() || [];
            const students = await window.JRStorage.getStudents() || [];
            const results = await window.JRStorage.getResults() || [];
            const settings = await window.JRStorage.getSettings() || {};
            
            // Count unique students with results
            const uniqueResultStudents = new Set(results.map(r => r.studentId)).size;
            
            setStats({
                tests: tests.length,
                students: students.length,
                active: 0, 
                results: uniqueResultStudents
            });
            setRegOpen(settings.registration_open !== false); 
            setResultsOpen(settings.results_open !== false);
        } catch (error) {
            console.error("Error loading stats:", error);
        } finally {
            setLoading(false);
        }
    };

    const toggleRegistration = async () => {
        const newState = !regOpen;
        setRegOpen(newState);
        await window.JRStorage.setSetting('registration_open', newState);
    };

    const toggleResults = async () => {
        const newState = !resultsOpen;
        setResultsOpen(newState);
        await window.JRStorage.setSetting('results_open', newState);
    };

    const copyLink = (path, name) => {
        const link = `${window.location.origin}/${path}`;
        navigator.clipboard.writeText(link);
        alert(`${name} Link Copied: ${link}`);
    };

    if (loading) return <div className="p-8 text-center text-gray-500">Loading Dashboard...</div>;

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-gray-800">Overview</h2>
                <div className="flex items-center space-x-3">
                    <div className="flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border px-4">
                        <span className="text-sm font-bold text-gray-600">Results Access:</span>
                        <button 
                            onClick={toggleResults}
                            className={`px-4 py-1 rounded-full text-xs font-bold transition-colors ${resultsOpen ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}
                        >
                            {resultsOpen ? 'ENABLED' : 'DISABLED'}
                        </button>
                    </div>
                    <div className="flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border px-4">
                        <span className="text-sm font-bold text-gray-600">Registration:</span>
                        <button 
                            onClick={toggleRegistration}
                            className={`px-4 py-1 rounded-full text-xs font-bold transition-colors ${regOpen ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}
                        >
                            {regOpen ? 'OPEN' : 'CLOSED'}
                        </button>
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-gray-500 mb-1">Total Tests</p>
                            <h3 className="text-3xl font-bold text-gray-900">{stats.tests}</h3>
                        </div>
                        <div className="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
                            <div className="icon-file-text text-blue-600 text-xl"></div>
                        </div>
                    </div>
                </div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-gray-500 mb-1">Registered Students</p>
                            <h3 className="text-3xl font-bold text-gray-900">{stats.students}</h3>
                        </div>
                        <div className="w-12 h-12 bg-emerald-50 rounded-lg flex items-center justify-center">
                            <div className="icon-users text-emerald-600 text-xl"></div>
                        </div>
                    </div>
                </div>
                 <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-gray-500 mb-1">Results Generated</p>
                            <h3 className="text-3xl font-bold text-gray-900">{stats.results}</h3>
                        </div>
                        <div className="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center">
                            <div className="icon-chart-bar text-purple-600 text-xl"></div>
                        </div>
                    </div>
                </div>
            </div>
            
             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                     <h3 className="font-bold mb-4">Direct Links</h3>
                     <div className="space-y-3">
                         <button onClick={() => copyLink('register.html', 'Registration')} className="w-full text-left p-3 hover:bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-between transition-all">
                            <div className="flex items-center space-x-3">
                                <div className="icon-user-plus text-amber-600"></div>
                                <span>Copy Registration Link</span>
                            </div>
                            <div className="icon-copy text-gray-400"></div>
                         </button>
                         <button onClick={() => copyLink('result.html', 'Result')} className="w-full text-left p-3 hover:bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-between transition-all">
                            <div className="flex items-center space-x-3">
                                <div className="icon-chart-bar text-purple-600"></div>
                                <span>Copy Result Checking Link</span>
                            </div>
                             <div className="icon-copy text-gray-400"></div>
                         </button>
                         <button onClick={() => copyLink('student.html', 'Portal')} className="w-full text-left p-3 hover:bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-between transition-all">
                            <div className="flex items-center space-x-3">
                                <div className="icon-graduation-cap text-emerald-600"></div>
                                <span>Copy Exam Portal Link</span>
                            </div>
                             <div className="icon-copy text-gray-400"></div>
                         </button>
                     </div>
                 </div>
             </div>
        </div>
    );
}

function QuestionEditor({ subjectIndex, onSave, onCancel, initialData }) {
    const [question, setQuestion] = useState(initialData || {
        text: '',
        options: ['', '', '', ''],
        correct: 0
    });

    const handleOptionChange = (idx, val) => {
        const newOpts = [...question.options];
        newOpts[idx] = val;
        setQuestion({...question, options: newOpts});
    };

    return (
        <div className="bg-white p-4 rounded border border-gray-300 mt-2">
            <h4 className="font-bold text-sm mb-2">{initialData ? 'Edit Question' : 'Add New Question'}</h4>
            <div className="mb-2">
                <label className="block text-xs font-bold mb-1">Question Text</label>
                <textarea 
                    className="w-full p-2 border rounded text-sm"
                    rows="2"
                    value={question.text}
                    onChange={e => setQuestion({...question, text: e.target.value})}
                    placeholder="Enter question here..."
                ></textarea>
            </div>
            <div className="grid grid-cols-2 gap-2 mb-2">
                {question.options.map((opt, idx) => (
                    <div key={idx} className="flex items-center">
                        <input 
                            type="radio" 
                            name="correctOpt"
                            checked={question.correct === idx}
                            onChange={() => setQuestion({...question, correct: idx})}
                            className="mr-2"
                        />
                        <input 
                            type="text"
                            className="flex-1 p-1 border rounded text-sm"
                            value={opt}
                            onChange={e => handleOptionChange(idx, e.target.value)}
                            placeholder={`Option ${String.fromCharCode(65 + idx)}`}
                        />
                    </div>
                ))}
            </div>
            <div className="flex justify-end gap-2">
                <button onClick={onCancel} className="text-xs px-3 py-1 bg-gray-200 rounded">Cancel</button>
                <button 
                    onClick={() => {
                        if(question.text && question.options.every(o => o)) {
                            onSave(question);
                            if(!initialData) setQuestion({ text: '', options: ['', '', '', ''], correct: 0 });
                        } else {
                            alert("Please fill all fields");
                        }
                    }} 
                    className="text-xs px-3 py-1 bg-blue-600 text-white rounded"
                >
                    {initialData ? 'Update' : 'Add'}
                </button>
            </div>
        </div>
    );
}

function TestManager() {
    const [tests, setTests] = useState([]);
    const [isCreating, setIsCreating] = useState(false);
    const [activeSubjectForQuestion, setActiveSubjectForQuestion] = useState(null);
    const [assigningTestId, setAssigningTestId] = useState(null);
    const [students, setStudents] = useState([]);
    const [loading, setLoading] = useState(false);
    
    // Edit Mode
    const [editingTestId, setEditingTestId] = useState(null);
    
    const [newTest, setNewTest] = useState({
        title: '',
        code: '',
        duration: 30, 
        startTime: '',
        endTime: '', 
        subjects: [{ name: '', questions: [] }]
    });

    useEffect(() => {
        loadData();
    }, []);

    const loadData = async () => {
        setLoading(true);
        const [t, s] = await Promise.all([
            window.JRStorage.getTests(),
            window.JRStorage.getStudents()
        ]);
        setTests(t);
        setStudents(s);
        setLoading(false);
    };

    const handleEdit = (test) => {
        setEditingTestId(test.id);
        setNewTest({
            title: test.title,
            code: test.code,
            duration: test.duration,
            startTime: test.startTime || '',
            endTime: test.endTime || '',
            subjects: test.subjects || []
        });
        setIsCreating(true);
    };

    const handleSave = async () => {
        if(!newTest.title || !newTest.code || newTest.subjects.length === 0) {
            alert("Please fill required fields and add at least one subject.");
            return;
        }

        try {
            const testPayload = {
                ...newTest,
                id: editingTestId || 'TEST-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                createdAt: new Date().toISOString(),
                assignedStudents: editingTestId ? (tests.find(t=>t.id===editingTestId)?.assignedStudents || []) : [] 
            };

            await window.JRStorage.saveTest(testPayload);
            await loadData();
            setIsCreating(false);
            setEditingTestId(null);
            setNewTest({ title: '', code: '', duration: 30, startTime: '', endTime: '', subjects: [{ name: '', questions: [] }] });
            alert("Test saved successfully!");
        } catch (e) {
            console.error("Save failed", e);
            alert("Failed to save test. Please try again.");
        }
    };

    const addSubject = () => {
        setNewTest({...newTest, subjects: [...newTest.subjects, { name: '', questions: [] }]});
    };
    
    const updateSubject = (index, field, value) => {
        const subs = [...newTest.subjects];
        subs[index][field] = value;
        setNewTest({...newTest, subjects: subs});
    };

    const addQuestionToSubject = (subjectIndex, question) => {
        const subs = [...newTest.subjects];
        subs[subjectIndex].questions.push({
            id: Date.now(),
            ...question
        });
        setNewTest({...newTest, subjects: subs});
        setActiveSubjectForQuestion(null);
    };

    const copyLink = (code) => {
        const link = `${window.location.origin}/student.html?code=${code}`;
        navigator.clipboard.writeText(link);
        alert(`Direct Link Copied: ${link}`);
    };

    const handleAssignment = async (testId, regNumbers) => {
        const test = tests.find(t => t.id === testId);
        if (test) {
            const updatedTest = { ...test, assignedStudents: regNumbers };
            await window.JRStorage.saveTest(updatedTest);
            await loadData();
            setAssigningTestId(null);
            alert("Assignments updated successfully!");
        }
    };

    const handleDeleteTest = async (id) => {
        if(confirm("Delete this test?")) {
            await window.JRStorage.deleteTest(id);
            loadData();
        }
    }

    const notifyStudents = (testId) => {
        alert("System Simulation: Emails sent to all assigned students with their exam slip link.");
    };

    if(loading && !assigningTestId) return <div>Loading...</div>;

    return (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold">Test Management</h2>
                <button 
                    onClick={() => {
                        setEditingTestId(null);
                        setNewTest({ title: '', code: '', duration: 30, startTime: '', endTime: '', subjects: [{ name: '', questions: [] }] });
                        setIsCreating(true);
                    }}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700"
                >
                    <div className="icon-plus"></div>
                    <span>Create Test</span>
                </button>
            </div>

            {/* Creating Interface */}
            {isCreating && (
                <div className="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
                    <h3 className="font-bold mb-4">{editingTestId ? 'Edit Test' : 'Create New Test'}</h3>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Test Title</label>
                            <input 
                                type="text" 
                                className="w-full p-2 border rounded"
                                value={newTest.title}
                                onChange={e => setNewTest({...newTest, title: e.target.value})}
                                placeholder="e.g. 2026 UTME Mock"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Test Code (Unique ID)</label>
                            <input 
                                type="text" 
                                className="w-full p-2 border rounded"
                                value={newTest.code}
                                onChange={e => setNewTest({...newTest, code: e.target.value})}
                                placeholder="e.g. 2026-MOCK-001"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Start Time (Access Open)</label>
                            <input 
                                type="datetime-local" 
                                className="w-full p-2 border rounded"
                                value={newTest.startTime}
                                onChange={e => setNewTest({...newTest, startTime: e.target.value})}
                            />
                        </div>
                         <div>
                            <label className="block text-sm font-medium mb-1">End Time (Access Expired)</label>
                            <input 
                                type="datetime-local" 
                                className="w-full p-2 border rounded"
                                value={newTest.endTime}
                                onChange={e => setNewTest({...newTest, endTime: e.target.value})}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Duration (Minutes)</label>
                            <input 
                                type="number" 
                                className="w-full p-2 border rounded"
                                value={newTest.duration}
                                onChange={e => setNewTest({...newTest, duration: parseInt(e.target.value)})}
                            />
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <label className="block text-sm font-medium mb-2">Subjects & Questions</label>
                        {newTest.subjects.map((sub, idx) => (
                            <div key={idx} className="bg-white p-4 rounded border mb-3">
                                <div className="flex gap-2 mb-2 items-center">
                                    <span className="font-bold text-gray-500">#{idx+1}</span>
                                    <input 
                                        type="text" 
                                        placeholder="Subject Name (e.g. Mathematics)"
                                        className="flex-1 p-2 border rounded"
                                        value={sub.name}
                                        onChange={e => updateSubject(idx, 'name', e.target.value)}
                                    />
                                    <div className="text-sm text-gray-500">{sub.questions.length} Questions</div>
                                    <button 
                                        onClick={() => {
                                            const subs = [...newTest.subjects];
                                            subs.splice(idx, 1);
                                            setNewTest({...newTest, subjects: subs});
                                        }}
                                        className="text-red-500 hover:text-red-700"
                                    >
                                        <div className="icon-trash"></div>
                                    </button>
                                </div>
                                
                                {activeSubjectForQuestion === idx ? (
                                    <QuestionEditor 
                                        subjectIndex={idx} 
                                        onSave={(q) => addQuestionToSubject(idx, q)}
                                        onCancel={() => setActiveSubjectForQuestion(null)}
                                    />
                                ) : (
                                    <button 
                                        onClick={() => setActiveSubjectForQuestion(idx)}
                                        className="text-xs text-blue-600 hover:underline flex items-center gap-1 mt-1"
                                    >
                                        <div className="icon-plus-circle text-xs"></div> Add Question
                                    </button>
                                )}
                            </div>
                        ))}
                        <button onClick={addSubject} className="text-sm text-emerald-600 font-bold flex items-center gap-1 mt-2">
                            <div className="icon-plus text-xs"></div> Add New Subject
                        </button>
                    </div>

                    <div className="flex gap-2">
                        <button onClick={handleSave} className="bg-green-600 text-white px-4 py-2 rounded">
                            {editingTestId ? 'Update Test' : 'Save Test'}
                        </button>
                        <button onClick={() => { setIsCreating(false); setEditingTestId(null); }} className="bg-gray-300 text-gray-800 px-4 py-2 rounded">Cancel</button>
                    </div>
                </div>
            )}

            {/* Assignment Modal */}
            {assigningTestId && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
                        <h3 className="text-lg font-bold mb-4">Assign Students to Test</h3>
                        <div className="flex-1 overflow-y-auto mb-4 border rounded p-2">
                             {students.length === 0 ? <p className="text-gray-500 p-4">No registered students found.</p> : (
                                 <div className="grid grid-cols-1 gap-2">
                                     <label className="flex items-center p-2 bg-gray-50 rounded font-bold">
                                         <input type="checkbox" className="mr-3" 
                                             onChange={(e) => {
                                                 const allRegs = e.target.checked ? students.map(s => s.regNumber) : [];
                                                 handleAssignment(assigningTestId, allRegs);
                                             }}
                                         />
                                         Select All / None (Caution)
                                     </label>
                                     {students.map(s => {
                                         const currentTest = tests.find(t => t.id === assigningTestId);
                                         const isAssigned = currentTest.assignedStudents && currentTest.assignedStudents.includes(s.regNumber);
                                         return (
                                             <label key={s.id} className="flex items-center p-2 hover:bg-gray-50 rounded border cursor-pointer">
                                                 <input 
                                                     type="checkbox" 
                                                     className="mr-3" 
                                                     checked={!!isAssigned}
                                                     onChange={(e) => {
                                                         let newAssigned = currentTest.assignedStudents || [];
                                                         if (e.target.checked) {
                                                             newAssigned = [...newAssigned, s.regNumber];
                                                         } else {
                                                             newAssigned = newAssigned.filter(r => r !== s.regNumber);
                                                         }
                                                         // UI Update only
                                                         const updatedTests = [...tests];
                                                         const tIdx = updatedTests.findIndex(t => t.id === assigningTestId);
                                                         updatedTests[tIdx].assignedStudents = newAssigned;
                                                         setTests(updatedTests);
                                                     }}
                                                 />
                                                 <div>
                                                     <span className="font-bold">{s.name}</span>
                                                     <span className="text-xs text-gray-500 ml-2">({s.regNumber})</span>
                                                 </div>
                                             </label>
                                         );
                                     })}
                                 </div>
                             )}
                        </div>
                        <div className="flex justify-between items-center">
                             <button 
                                 onClick={() => notifyStudents(assigningTestId)}
                                 className="text-blue-600 hover:text-blue-800 text-sm font-bold flex items-center gap-2"
                             >
                                 <div className="icon-mail"></div> Notify Selected Students
                             </button>
                             <div className="flex gap-2">
                                 <button onClick={() => setAssigningTestId(null)} className="px-4 py-2 text-gray-600">Cancel</button>
                                 <button 
                                     onClick={() => {
                                         const currentTest = tests.find(t => t.id === assigningTestId);
                                         handleAssignment(assigningTestId, currentTest.assignedStudents || []);
                                     }}
                                     className="bg-blue-600 text-white px-4 py-2 rounded"
                                 >
                                     Save Assignments
                                 </button>
                             </div>
                        </div>
                    </div>
                </div>
            )}

            <div className="overflow-x-auto">
                <table className="w-full">
                    <thead className="bg-gray-50 border-b">
                        <tr>
                            <th className="p-3 text-left">Code</th>
                            <th className="p-3 text-left">Title</th>
                            <th className="p-3 text-left">Assigned</th>
                            <th className="p-3 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {tests.map(test => (
                            <tr key={test.id} className="border-b hover:bg-gray-50">
                                <td className="p-3 font-mono text-sm">{test.code}</td>
                                <td className="p-3 font-medium">{test.title}</td>
                                <td className="p-3 text-sm">
                                    {(test.assignedStudents && test.assignedStudents.length > 0) 
                                        ? <span className="text-green-600 font-bold">{test.assignedStudents.length} Candidates</span> 
                                        : <span className="text-gray-400">Open to All</span>}
                                </td>
                                <td className="p-3 flex gap-2">
                                    <button 
                                        onClick={() => handleEdit(test)}
                                        className="text-gray-600 hover:text-black p-1 border border-gray-200 rounded"
                                        title="Edit Test"
                                    >
                                        <div className="icon-pencil"></div>
                                    </button>
                                    <button 
                                        onClick={() => setAssigningTestId(test.id)}
                                        className="text-purple-600 hover:text-purple-800 p-1 border border-purple-200 rounded"
                                        title="Assign Students"
                                    >
                                        <div className="icon-users"></div>
                                    </button>
                                    <button 
                                        onClick={() => copyLink(test.code)}
                                        className="text-blue-600 hover:text-blue-800 p-1 border border-blue-200 rounded"
                                        title="Copy Direct Link"
                                    >
                                        <div className="icon-link"></div>
                                    </button>
                                    <button 
                                        onClick={() => handleDeleteTest(test.id)} 
                                        className="text-red-600 hover:text-red-800 p-1 border border-red-200 rounded"
                                        title="Delete Test"
                                    >
                                        <div className="icon-trash"></div>
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
}

// StudentManager (mostly same, slight update to display departments if needed)
function StudentManager() {
    const [students, setStudents] = useState([]);
    const [receiptStudent, setReceiptStudent] = useState(null);
    const [viewStudent, setViewStudent] = useState(null);
    const [isAdding, setIsAdding] = useState(false);
    
    // Receipt Edit State
    const [receiptData, setReceiptData] = useState({ amount: '5,000.00', purpose: 'UTME PRACTICE' });
    const [isEditingReceipt, setIsEditingReceipt] = useState(false);

    // Manual Add State
    const [newStudent, setNewStudent] = useState({
        name: '', email: '', phone: '', stateOrigin: '', lga: '', address: '', department: '',
        customRegNumber: '' 
    });

    useEffect(() => {
        loadStudents();
    }, []);

    const loadStudents = async () => {
        const s = await window.JRStorage.getStudents();
        setStudents(s);
    };

    const handleDelete = async (regNumber) => {
        if(confirm("Are you sure you want to PERMANENTLY remove this student?")) {
            await window.JRStorage.deleteStudent(regNumber);
            loadStudents();
        }
    };

    const handleManualAdd = async () => {
        if(!newStudent.name || !newStudent.phone) {
            alert("Name and Phone are required.");
            return;
        }
        
        let regNumber = newStudent.customRegNumber;
        if (!regNumber) {
            const year = new Date().getFullYear();
            const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            regNumber = `JR${year}${randomNum}`;
        }
        
        // Check duplicate reg
        const existing = students.find(s => s.regNumber === regNumber);
        if(existing) {
            alert(`Registration Number ${regNumber} already exists!`);
            return;
        }

        const studentData = {
            id: 'ST-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
            ...newStudent,
            regNumber: regNumber,
            registeredAt: new Date().toISOString(),
            passport: null 
        };
        // Clean up UI field
        delete studentData.customRegNumber;

        try {
            await window.JRStorage.saveStudent(studentData);
            alert(`Student Added! Reg No: ${regNumber}`);
            setIsAdding(false);
            setNewStudent({ name: '', email: '', phone: '', stateOrigin: '', lga: '', address: '', department: '', customRegNumber: '' });
            loadStudents();
        } catch(e) {
            alert("Error adding student.");
        }
    };

    return (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-lg">Registered Students</h3>
                <div className="flex items-center gap-4">
                    <button 
                        onClick={() => setIsAdding(true)}
                        className="bg-emerald-600 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2"
                    >
                        <div className="icon-plus"></div> Add Student
                    </button>
                    <div className="text-sm text-gray-500">Total: {students.length}</div>
                </div>
            </div>

            {isAdding && (
                <div className="mb-6 p-4 bg-gray-50 rounded border border-gray-200">
                    <h4 className="font-bold mb-3">Manual Registration</h4>
                    <div className="grid grid-cols-2 gap-3 mb-3">
                        <input className="p-2 border rounded" placeholder="Full Name" value={newStudent.name} onChange={e => setNewStudent({...newStudent, name: e.target.value})} />
                        <input className="p-2 border rounded" placeholder="Phone" value={newStudent.phone} onChange={e => setNewStudent({...newStudent, phone: e.target.value})} />
                        <input className="p-2 border rounded" placeholder="Email" value={newStudent.email} onChange={e => setNewStudent({...newStudent, email: e.target.value})} />
                        <input className="p-2 border rounded" placeholder="Department" value={newStudent.department} onChange={e => setNewStudent({...newStudent, department: e.target.value})} />
                        <div className="col-span-2">
                             <input className="p-2 border rounded w-full border-blue-300 bg-blue-50" placeholder="Custom Registration Number (Optional - Leave blank to auto-generate)" value={newStudent.customRegNumber} onChange={e => setNewStudent({...newStudent, customRegNumber: e.target.value})} />
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={handleManualAdd} className="bg-blue-600 text-white px-4 py-1 rounded text-sm">Save</button>
                        <button onClick={() => setIsAdding(false)} className="bg-gray-300 text-black px-4 py-1 rounded text-sm">Cancel</button>
                    </div>
                </div>
            )}
            
            <div className="overflow-y-auto max-h-[600px]">
                <table className="w-full">
                    <thead className="bg-gray-50 border-b sticky top-0">
                        <tr>
                            <th className="p-3 text-left">Student Details</th>
                            <th className="p-3 text-left">Contact</th>
                            <th className="p-3 text-left">Department</th>
                            <th className="p-3 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {students.map(student => (
                            <tr key={student.id} className="border-b">
                                <td className="p-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-gray-200 rounded-full overflow-hidden">
                                            {student.passport ? 
                                                <img src={student.passport} className="w-full h-full object-cover" /> :
                                                <div className="icon-user w-full h-full flex items-center justify-center text-gray-400"></div>
                                            }
                                        </div>
                                        <div>
                                            <div className="font-bold">{student.name}</div>
                                            <div className="text-xs text-gray-500 font-mono">{student.regNumber}</div>
                                        </div>
                                    </div>
                                </td>
                                <td className="p-3 text-sm">
                                    <div className="text-gray-900">{student.phone}</div>
                                    <div className="text-gray-500 text-xs">{student.email}</div>
                                </td>
                                <td className="p-3 text-sm">
                                    {student.department || 'N/A'}
                                </td>
                                <td className="p-3 flex gap-2">
                                    <button onClick={() => setViewStudent(student)} className="text-gray-600 hover:bg-gray-100 p-1 rounded" title="View Full Details">
                                        <div className="icon-eye"></div>
                                    </button>
                                    <button onClick={() => setReceiptStudent(student)} className="text-blue-600 hover:bg-blue-50 p-1 rounded" title="Print Receipt">
                                        <div className="icon-printer"></div>
                                    </button>
                                    <button onClick={() => handleDelete(student.regNumber)} className="text-red-600 hover:bg-red-50 p-1 rounded" title="Remove">
                                        <div className="icon-trash"></div>
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* View Modal */}
            {viewStudent && (
                 <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-white w-full max-w-lg p-6 rounded-xl relative">
                        <button onClick={() => setViewStudent(null)} className="absolute top-4 right-4 text-gray-500 hover:text-red-500">
                            <div className="icon-x text-2xl"></div>
                        </button>
                        <h3 className="text-xl font-bold mb-6">Student Profile</h3>
                        <div className="flex flex-col items-center mb-6">
                            <div className="w-32 h-32 bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200 mb-4">
                                {viewStudent.passport ? 
                                    <img src={viewStudent.passport} className="w-full h-full object-cover" /> :
                                    <div className="w-full h-full flex items-center justify-center text-gray-400">No Photo</div>
                                }
                            </div>
                            <h2 className="text-2xl font-bold">{viewStudent.name}</h2>
                            <p className="font-mono text-emerald-600 font-bold">{viewStudent.regNumber}</p>
                        </div>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                            <div className="p-3 bg-gray-50 rounded">
                                <span className="block text-gray-500 text-xs">Email</span>
                                <span className="font-medium">{viewStudent.email}</span>
                            </div>
                            <div className="p-3 bg-gray-50 rounded">
                                <span className="block text-gray-500 text-xs">Phone</span>
                                <span className="font-medium">{viewStudent.phone}</span>
                            </div>
                             <div className="p-3 bg-gray-50 rounded">
                                <span className="block text-gray-500 text-xs">Department</span>
                                <span className="font-medium">{viewStudent.department || 'N/A'}</span>
                            </div>
                            <div className="p-3 bg-gray-50 rounded">
                                <span className="block text-gray-500 text-xs">Registered</span>
                                <span className="font-medium">{new Date(viewStudent.registeredAt).toLocaleDateString()}</span>
                            </div>
                             <div className="p-3 bg-gray-50 rounded col-span-2">
                                <span className="block text-gray-500 text-xs">Subjects</span>
                                <span className="font-medium">{viewStudent.selectedSubjects ? viewStudent.selectedSubjects.join(', ') : 'None'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}
             {/* Receipt Modal with Edit */}
             {receiptStudent && (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-white w-full max-w-md p-0 overflow-hidden rounded shadow-2xl relative">
                         {isEditingReceipt ? (
                             <div className="p-6">
                                 <h3 className="font-bold mb-4">Edit Receipt Details</h3>
                                 <div className="mb-4">
                                     <label className="block text-xs font-bold mb-1">Amount</label>
                                     <input className="w-full p-2 border rounded" value={receiptData.amount} onChange={e => setReceiptData({...receiptData, amount: e.target.value})} />
                                 </div>
                                 <div className="mb-4">
                                     <label className="block text-xs font-bold mb-1">Purpose/Item</label>
                                     <input className="w-full p-2 border rounded" value={receiptData.purpose} onChange={e => setReceiptData({...receiptData, purpose: e.target.value})} />
                                 </div>
                                 <button onClick={() => setIsEditingReceipt(false)} className="bg-blue-600 text-white px-4 py-2 rounded w-full">Done</button>
                             </div>
                         ) : (
                             <>
                                <button onClick={() => setReceiptStudent(null)} className="absolute top-2 right-2 text-gray-500 hover:text-red-500 no-print">
                                    <div className="icon-x-circle text-2xl"></div>
                                </button>
                                
                                <div id="receipt-area" className="p-8 border-4 border-double border-gray-300 m-4 relative overflow-hidden">
                                     {/* Watermark */}
                                     <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                                        <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-[80%] h-[80%] object-contain" />
                                    </div>

                                    <div className="text-center border-b-2 border-dashed border-gray-300 pb-4 mb-4 relative z-10">
                                        <h1 className="text-xl font-black uppercase">JR NGR</h1>
                                        <p className="text-xs tracking-widest">Official Payment Receipt</p>
                                    </div>
                                    
                                    <div className="space-y-4 text-sm font-mono mb-6 relative z-10">
                                        <div className="flex justify-between">
                                            <span className="text-gray-500">Date:</span>
                                            <span>{new Date().toLocaleDateString()}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-500">Receipt No:</span>
                                            <span>MANUAL-{Math.floor(Math.random()*100000)}</span>
                                        </div>
                                        <div className="border-t border-dashed border-gray-200 my-2"></div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-500">Student Name:</span>
                                            <span className="font-bold text-right">{receiptStudent.name}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-500">Reg No:</span>
                                            <span className="font-bold">{receiptStudent.regNumber}</span>
                                        </div>
                                         <div className="flex justify-between">
                                            <span className="text-gray-500">Payment For:</span>
                                            <span className="font-bold">{receiptData.purpose}</span>
                                        </div>
                                        <div className="border-t border-dashed border-gray-200 my-2"></div>
                                        <div className="flex justify-between font-bold text-lg">
                                            <span>TOTAL PAID:</span>
                                            <span>₦ {receiptData.amount}</span>
                                        </div>
                                    </div>
                                    
                                    <div className="text-center text-[10px] text-gray-400 mt-6 relative z-10">
                                        <p>Admin Generated - JR NGR Portal</p>
                                    </div>
                                </div>

                                <div className="bg-gray-100 p-4 flex justify-between no-print">
                                    <button onClick={() => setIsEditingReceipt(true)} className="text-blue-600 text-xs font-bold underline">Edit Details</button>
                                    <button onClick={() => window.print()} className="bg-blue-900 text-white px-6 py-2 rounded font-bold flex items-center gap-2">
                                        <div className="icon-printer"></div> Print Now
                                    </button>
                                </div>
                             </>
                         )}
                    </div>
                </div>
            )}
        </div>
    );
}

// LiveMonitor - Professional CCTV Style
function LiveMonitor() {
    const [sessions, setSessions] = useState({});
    const [msgText, setMsgText] = useState('');
    const [currentTime, setCurrentTime] = useState(Date.now());
    const [selectedStudent, setSelectedStudent] = useState(null);

    useEffect(() => {
        // High frequency refresh for "movement" effect (Snapshot polling)
        const fetchInterval = setInterval(async () => {
            try {
                const sess = await window.JRStorage.getLiveSessions() || {};
                setSessions(sess);
            } catch (e) {
                // Silent catch
            }
        }, 1000); 

        // Local UI timer for "Last Seen X seconds ago" update
        const timerInterval = setInterval(() => {
            setCurrentTime(Date.now());
        }, 1000);

        return () => {
            clearInterval(fetchInterval);
            clearInterval(timerInterval);
        };
    }, []);

    const sendMessage = async (studentId) => {
        if(!msgText) return;
        await window.JRStorage.sendMessage(studentId, msgText);
        setMsgText('');
        alert(`Message sent to ${studentId}!`);
    };

    const sessionList = Object.entries(sessions);
    
    // FILTER: Only active students (last seen < 30 seconds ago)
    const activeSessions = sessionList.filter(([_, s]) => {
         const lastSeenMs = new Date(s.lastSeen).getTime();
         const diffSeconds = (Date.now() - lastSeenMs) / 1000;
         return diffSeconds < 30; // 30s threshold
    });

    const activeCount = activeSessions.length;

    return (
        <div className="bg-[#1e293b] p-6 rounded-xl shadow-2xl min-h-[calc(100vh-100px)] text-gray-200 border border-gray-700 flex flex-col">
            <div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <div>
                    <h2 className="text-xl font-bold flex items-center text-white tracking-wider">
                        <div className="w-3 h-3 bg-red-500 rounded-full animate-pulse mr-3 shadow-[0_0_10px_#ef4444]"></div>
                        SECURITY MONITORING CENTER
                    </h2>
                    <p className="text-xs text-gray-400 mt-1 font-mono">SYSTEM STATUS: ONLINE | ACTIVE FEEDS: {activeCount}</p>
                </div>
                <div className="text-right font-mono text-sm text-emerald-500">
                    {new Date(currentTime).toLocaleTimeString()}
                </div>
            </div>

            {activeSessions.length === 0 ? (
                <div className="flex-1 flex flex-col items-center justify-center text-gray-600 border-2 border-dashed border-gray-700 rounded-xl bg-gray-800/50">
                    <div className="icon-monitor-off text-6xl mb-4 opacity-50"></div>
                    <p className="text-lg font-bold">NO ACTIVE SESSIONS</p>
                    <p className="text-sm">Waiting for candidates to connect...</p>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pr-2">
                    {activeSessions.map(([id, session]) => {
                        const lastSeenMs = new Date(session.lastSeen).getTime();
                        const diffSeconds = Math.floor((currentTime - lastSeenMs) / 1000);
                        const isOnline = diffSeconds < 15;
                        const borderColor = isOnline ? 'border-emerald-500/50' : 'border-red-500/50';
                        const statusText = isOnline ? 'LIVE' : `DELAY ${diffSeconds}s`;
                        const statusColor = isOnline ? 'text-emerald-400' : 'text-red-400';

                        return (
                            <div key={id} className={`bg-gray-900 border-2 ${borderColor} rounded-lg overflow-hidden flex flex-col shadow-lg transition-all hover:border-blue-500/50`}>
                                {/* Header */}
                                <div className="bg-gray-800 px-3 py-2 flex justify-between items-center border-b border-gray-700">
                                    <div className="flex items-center space-x-2 overflow-hidden">
                                        <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`}></div>
                                        <span className="font-mono text-xs font-bold truncate text-white max-w-[120px]" title={session.name}>{session.name}</span>
                                    </div>
                                    <span className={`text-[10px] font-mono font-bold ${statusColor}`}>{statusText}</span>
                                </div>
                                
                                {/* Feed */}
                                <div className="relative aspect-video bg-black flex items-center justify-center group">
                                    {session.snapshot ? (
                                        <img src={session.snapshot} className="w-full h-full object-cover opacity-90" />
                                    ) : (
                                        <div className="flex flex-col items-center opacity-30">
                                            <div className="icon-video-off text-4xl mb-2"></div>
                                            <span className="text-[10px]">NO SIGNAL</span>
                                        </div>
                                    )}
                                    
                                    {/* Overlay Info */}
                                    <div className="absolute top-2 left-2 bg-black/70 px-1.5 py-0.5 rounded text-[10px] font-mono text-white border border-white/10">
                                        CAM-{id.slice(-4)}
                                    </div>
                                    
                                    {/* Warnings */}
                                    {session.warningCount > 0 && (
                                        <div className="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded animate-pulse shadow-lg">
                                            WARN: {session.warningCount}
                                        </div>
                                    )}

                                    {/* Movement Indicator (Visual Gimmick) */}
                                    {isOnline && (
                                        <div className="absolute bottom-2 right-2 flex space-x-0.5">
                                            <div className="w-0.5 h-3 bg-green-500 animate-[pulse_0.5s_ease-in-out_infinite]"></div>
                                            <div className="w-0.5 h-2 bg-green-500 animate-[pulse_0.7s_ease-in-out_infinite]"></div>
                                            <div className="w-0.5 h-4 bg-green-500 animate-[pulse_0.3s_ease-in-out_infinite]"></div>
                                        </div>
                                    )}
                                </div>

                                {/* Footer Controls */}
                                <div className="p-2 bg-gray-800 border-t border-gray-700 space-y-2">
                                    <div className="flex justify-between text-[10px] text-gray-400 font-mono">
                                        <span>ID: {session.regNumber}</span>
                                        <span>TEST: {session.testCode}</span>
                                    </div>
                                    <div className="flex gap-1">
                                        <input 
                                            type="text" 
                                            placeholder="Alert candidate..."
                                            className="flex-1 bg-gray-900 border border-gray-700 rounded px-2 py-1 text-xs text-white focus:border-blue-500 outline-none"
                                            value={selectedStudent === id ? msgText : ''}
                                            onChange={(e) => {
                                                setSelectedStudent(id);
                                                setMsgText(e.target.value);
                                            }}
                                            onKeyPress={(e) => {
                                                if(e.key === 'Enter') sendMessage(session.regNumber, msgText);
                                            }}
                                        />
                                        <button 
                                            onClick={() => sendMessage(session.regNumber, msgText)}
                                            className="bg-blue-600 hover:bg-blue-500 text-white px-2 rounded text-xs flex items-center justify-center"
                                            title="Send Message"
                                        >
                                            <div className="icon-send"></div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}
        </div>
    );
}

function ResultsView() {
    const [results, setResults] = useState([]);
    const [printResult, setPrintResult] = useState(null);
    const [loading, setLoading] = useState(true);
    const [stats, setStats] = useState(null);

    useEffect(() => {
        load();
    }, []);

    const load = async () => {
         try {
             const res = await window.JRStorage.getResults();
             // FORCE UPDATE: Sometimes Storage returns cached or pagination partials?
             // Not really, but good to check. 
             setResults(res);
             
             // Analytics
             if(res.length > 0) {
                 const scores = res.map(r => r.score);
                 const avg = scores.reduce((a,b)=>a+b,0) / scores.length;
                 const max = Math.max(...scores);
                 const total = scores.reduce((a,b)=>a+b,0);
                 setStats({ avg: Math.round(avg), max, total });
             }
         } catch(e) {
             console.error("Failed to load results", e);
         } finally {
             setLoading(false);
         }
    }

    const toggleApprove = async (result, approvedStatus) => {
        await window.JRStorage.update(
            'result', 
            result._id, 
            { ...result, approved: approvedStatus }
        );
        load();
    };

    const handleDeleteResult = async (resultId) => {
        if(confirm("Permanently delete this result?")) {
            await window.JRStorage.delete('result', resultId);
            load();
        }
    }

    if (printResult) {
        // Minimal Print View for Admin
        return (
            <div className="fixed inset-0 bg-white z-50 overflow-auto">
                <div className="p-4 no-print flex justify-between bg-gray-100 mb-4">
                    <button onClick={() => setPrintResult(null)} className="font-bold">Close</button>
                    <button onClick={() => window.print()} className="bg-blue-600 text-white px-4 py-1 rounded">Print Now</button>
                </div>
                <div className="max-w-2xl mx-auto border-2 border-black p-8 relative">
                    <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                        <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-96 h-96 object-contain" />
                    </div>
                    <div className="text-center border-b-2 border-black pb-4 mb-4">
                        <h1 className="text-3xl font-black uppercase">JR NAGARA ONLINE TEST</h1>
                        <p className="font-bold">UTME PRACTICE RESULT SHEET</p>
                    </div>
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div><b>Name:</b> {printResult.studentName}</div>
                        <div><b>Reg No:</b> {printResult.studentId}</div>
                        <div><b>Test:</b> {printResult.testCode}</div>
                        <div><b>Date:</b> {new Date().toLocaleDateString()}</div>
                    </div>
                    <table className="w-full border-collapse border border-black mb-6">
                        <thead>
                            <tr className="bg-gray-200">
                                <th className="border border-black p-2 text-left">Subject</th>
                                <th className="border border-black p-2 text-right">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {results.filter(r => r.studentId === printResult.studentId && r.testCode === printResult.testCode).map((r, i) => (
                                <tr key={i}>
                                    <td className="border border-black p-2">{r.subject}</td>
                                    <td className="border border-black p-2 text-right font-bold">{r.score}</td>
                                </tr>
                            ))}
                             <tr className="bg-gray-100">
                                <td className="border border-black p-2 font-bold text-right">TOTAL</td>
                                <td className="border border-black p-2 text-right font-bold text-xl">
                                    {results.filter(r => r.studentId === printResult.studentId && r.testCode === printResult.testCode).reduce((a,b)=>a+b.score, 0)}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div className="flex justify-between items-end mt-12">
                         <div className="text-center flex flex-col items-center">
                             {/* REMOVED SPECIFIC SIGNATURE AS REQUESTED, USE TEXT INSTEAD */}
                             <div className="text-2xl font-signature font-bold italic mb-2">Authorized Signatory</div>
                             <div className="border-t border-black w-48 mt-1"></div>
                             <p className="text-xs font-bold mt-1">FOR: JR NAGARA MANAGEMENT</p>
                         </div>
                         <div className="text-xs text-right">
                             Generated from Admin Portal<br/>
                             JR NAGARA ONLINE TEST
                         </div>
                    </div>
                </div>
            </div>
        )
    }

    if (loading) return <div>Loading results...</div>;

    // Group by student for better view
    const grouped = {};
    results.forEach(r => {
        if(!grouped[r.studentId]) grouped[r.studentId] = { 
            name: r.studentName, 
            id: r.studentId, 
            test: r.testCode,
            results: []
        };
        grouped[r.studentId].results.push(r);
    });

    return (
        <div className="space-y-6">
            {/* Analytics Panel */}
            {stats && (
                 <div className="grid grid-cols-3 gap-4 mb-6">
                     <div className="bg-white p-4 rounded shadow-sm border-l-4 border-blue-500">
                         <div className="text-gray-500 text-xs">Average Score</div>
                         <div className="text-2xl font-bold">{stats.avg}</div>
                     </div>
                     <div className="bg-white p-4 rounded shadow-sm border-l-4 border-green-500">
                         <div className="text-gray-500 text-xs">Highest Score</div>
                         <div className="text-2xl font-bold">{stats.max}</div>
                     </div>
                      <div className="bg-white p-4 rounded shadow-sm border-l-4 border-purple-500">
                         <div className="text-gray-500 text-xs">Total Records</div>
                         <div className="text-2xl font-bold">{results.length}</div>
                     </div>
                 </div>
            )}

            <div className="bg-white p-6 rounded-xl shadow-sm">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold">Student Results</h2>
                    <button onClick={load} className="text-sm text-blue-600 hover:underline">Refresh List</button>
                </div>
                
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead className="bg-gray-50 border-b">
                            <tr>
                                 <th className="p-3 text-left">Student</th>
                                 <th className="p-3 text-left">Test</th>
                                 <th className="p-3 text-left">Subjects Taken</th>
                                 <th className="p-3 text-left">Aggregate</th>
                                 <th className="p-3 text-left">Status</th>
                                 <th className="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {Object.values(grouped).map((group, i) => {
                                const agg = group.results.reduce((a, b) => a + b.score, 0);
                                const isApproved = group.results.every(r => r.approved);
                                return (
                                    <tr key={i} className="border-b hover:bg-gray-50">
                                        <td className="p-3">
                                            <div className="font-medium">{group.name}</div>
                                            <div className="text-xs text-gray-500 font-mono">{group.id}</div>
                                        </td>
                                        <td className="p-3">{group.test}</td>
                                        <td className="p-3">
                                            <div className="flex flex-wrap gap-1">
                                                {group.results.map((r, idx) => (
                                                    <span key={idx} className="bg-gray-100 px-2 py-0.5 rounded text-xs">{r.subject}: {r.score}</span>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 font-bold text-lg">{agg}</td>
                                        <td className="p-3">
                                            {isApproved ? 
                                                <span className="text-green-600 font-bold text-xs bg-green-50 px-2 py-1 rounded">Approved</span> : 
                                                <span className="text-amber-600 font-bold text-xs bg-amber-50 px-2 py-1 rounded">Pending</span>
                                            }
                                        </td>
                                        <td className="p-3 flex gap-2">
                                            <button 
                                                onClick={() => setPrintResult(group.results[0])}
                                                className="text-blue-600 hover:bg-blue-50 p-1 border border-blue-200 rounded"
                                                title="Print Result Slip"
                                            >
                                                <div className="icon-printer"></div>
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    group.results.forEach(r => toggleApprove(r, !isApproved));
                                                }}
                                                className={`p-1 rounded border ${isApproved ? 'text-amber-600 border-amber-200' : 'text-green-600 border-green-200'}`}
                                                title={isApproved ? "Revoke Approval" : "Approve Result"}
                                            >
                                                {isApproved ? <div className="icon-x-circle"></div> : <div className="icon-circle-check"></div>}
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    group.results.forEach(r => handleDeleteResult(r._id));
                                                }}
                                                className="text-red-600 hover:bg-red-50 p-1 border border-red-200 rounded" 
                                                title="Delete Result"
                                            >
                                                <div className="icon-trash"></div>
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                            {Object.keys(grouped).length === 0 && (
                                <tr><td colSpan="6" className="p-6 text-center text-gray-400">No results found</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}

// Main App Container
function AdminApp() {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [activeTab, setActiveTab] = useState('dashboard');
    const [portalSettings, setPortalSettings] = useState({});

    useEffect(() => {
        loadSettings();
    }, []);

    const loadSettings = async () => {
        const s = await window.JRStorage.getSettings();
        setPortalSettings(s);
    };

    if (!isAuthenticated) {
        return <Login onLogin={() => setIsAuthenticated(true)} portalSettings={portalSettings} />;
    }

    return (
        <div className="flex">
            <Sidebar activeTab={activeTab} onTabChange={setActiveTab} onLogout={() => setIsAuthenticated(false)} portalSettings={portalSettings} />
            <main className="flex-1 ml-64 p-8 min-h-screen relative">
                {activeTab === 'dashboard' && <Dashboard setActiveTab={setActiveTab} />}
                {activeTab === 'tests' && <TestManager />}
                {activeTab === 'students' && <StudentManager />}
                {activeTab === 'monitor' && <LiveMonitor />}
                {activeTab === 'results' && <ResultsView />}
                {activeTab === 'settings' && <SettingsManager settings={portalSettings} onUpdate={loadSettings} />}
            </main>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <AdminApp />
  </React.StrictMode>
);
// Important: DO NOT remove this `ErrorBoundary` component.
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.error('ErrorBoundary caught an error:', error, errorInfo.componentStack);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <div className="text-center">
            <h1 className="text-2xl font-bold text-gray-900 mb-4">Something went wrong</h1>
            <p className="text-gray-600 mb-4">We're sorry, but something unexpected happened.</p>
            <button
              onClick={() => window.location.reload()}
              className="btn btn-black"
            >
              Reload Page
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

function App() {
  try {
    // replace the below code with your app code
    return (
      <div className="min-h-screen flex items-center justify-center" data-name="app" data-file="app.js">
        <h1 className="text-3xl font-bold"></h1>
      </div>
    );
  } catch (error) {
    console.error('App component error:', error);
    return null;
  }
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <ErrorBoundary>
    <App />
  </ErrorBoundary>
);
const { useState, useEffect, useRef } = React;

function Login({ onLogin, directMode }) {
    const [regNumber, setRegNumber] = useState('');
    const [testCode, setTestCode] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    
    // Recovery State
    const [showRecover, setShowRecover] = useState(false);
    const [recoverPhone, setRecoverPhone] = useState('');
    const [recoverEmail, setRecoverEmail] = useState('');
    const [recoverResult, setRecoverResult] = useState(null);

    useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        if (code) setTestCode(code);
    }, []);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
            const students = await window.JRStorage.getStudents();
            const student = students.find(s => s.regNumber === regNumber);
            
            const tests = await window.JRStorage.getTests();
            const test = tests.find(t => t.code === testCode);

            if (!student) {
                setError('Invalid Registration Number. Please contact admin.');
                setLoading(false);
                return;
            }
            if (!test) {
                setError('Invalid Test Code. Please check the link.');
                setLoading(false);
                return;
            }

            // Assignment Check
            if (test.assignedStudents && test.assignedStudents.length > 0) {
                if (!test.assignedStudents.includes(student.regNumber)) {
                    setError('You are not authorized to take this specific test. Please contact admin.');
                    setLoading(false);
                    return;
                }
            }

            // Time Checks
            const now = new Date();
            const startTime = new Date(test.startTime);
            const endTime = new Date(test.endTime);
            // Allow access 10 minutes before for verification setup
            const accessWindow = new Date(startTime.getTime() - 10 * 60 * 1000); 

            console.log("Time Check:", { now, accessWindow, startTime, endTime });

            if (now < accessWindow) {
                setError(`Portal not open yet. Access Allowed from: ${accessWindow.toLocaleTimeString()} (${startTime.toLocaleTimeString()} Start)`);
                setLoading(false);
                return;
            }

            if (now > endTime) {
                setError('Test Access Expired. You cannot take this test anymore.');
                setLoading(false);
                return;
            }

            onLogin(student, test);
        } catch(err) {
            console.error(err);
            setError('System Error. Please try again.');
        }
        setLoading(false);
    };

    const handleRecover = async (e) => {
        e.preventDefault();
        const students = await window.JRStorage.getStudents();
        const match = students.find(s => 
            s.email.toLowerCase() === recoverEmail.toLowerCase() && 
            s.phone === recoverPhone
        );

        if(match) {
            setRecoverResult(match);
        } else {
            alert("No matching record found with this Email AND Phone combination.");
        }
    };

    if (showRecover) {
        return (
            <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50">
                 <div className="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl relative">
                    <button onClick={() => setShowRecover(false)} className="absolute top-4 right-4 text-gray-400 hover:text-black"><div className="icon-x"></div></button>
                    <h2 className="text-xl font-bold mb-4">Recover Registration</h2>
                    
                    {!recoverResult ? (
                        <form onSubmit={handleRecover} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Registered Phone</label>
                                <input type="tel" className="w-full p-2 border rounded" required value={recoverPhone} onChange={e => setRecoverPhone(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Registered Email</label>
                                <input type="email" className="w-full p-2 border rounded" required value={recoverEmail} onChange={e => setRecoverEmail(e.target.value)} />
                            </div>
                            <button className="w-full bg-blue-600 text-white py-2 rounded font-bold">Search Record</button>
                        </form>
                    ) : (
                        <div className="text-center">
                            <div className="icon-circle-check text-4xl text-green-500 mx-auto mb-2"></div>
                            <p>Record Found!</p>
                            <div className="bg-gray-100 p-4 rounded my-4">
                                <p className="text-sm text-gray-500">Your Registration Number</p>
                                <p className="text-2xl font-mono font-bold text-blue-900">{recoverResult.regNumber}</p>
                                <p className="font-bold mt-2">{recoverResult.name}</p>
                            </div>
                            <button onClick={() => {
                                setRegNumber(recoverResult.regNumber);
                                setShowRecover(false);
                                setRecoverResult(null);
                            }} className="text-blue-600 underline text-sm">Use this to Login</button>
                        </div>
                    )}
                 </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl">
                <div className="text-center mb-8">
                     <div className="w-20 h-20 mx-auto mb-4 rounded-full overflow-hidden border-4 border-gray-100 shadow-lg">
                        <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-full h-full object-cover" />
                     </div>
                    <h1 className="text-2xl font-bold text-gray-900 uppercase">JR NAGARA ONLINE TEST</h1>
                    <p className="text-gray-500">Student Examination Portal</p>
                </div>
                
                {error && (
                    <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-6 text-sm flex items-center">
                        <div className="icon-circle-alert mr-2"></div>
                        {error}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium mb-1 text-gray-700">Registration Number</label>
                        <input 
                            type="text" 
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all"
                            value={regNumber}
                            onChange={e => setRegNumber(e.target.value)}
                            placeholder="Enter Reg No"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-1 text-gray-700">Test Code</label>
                        <input 
                            type="text" 
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all"
                            value={testCode}
                            onChange={e => setTestCode(e.target.value)}
                            placeholder="Enter Test Code"
                            required
                        />
                    </div>
                    <button type="submit" disabled={loading} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700 transition-colors shadow-lg shadow-emerald-200 disabled:opacity-50">
                        {loading ? 'Verifying...' : 'Proceed to Verification'}
                    </button>
                </form>

                <div className="mt-6 text-center">
                    <button onClick={() => setShowRecover(true)} className="text-sm text-emerald-600 font-medium hover:underline">
                        Forgot Registration Number?
                    </button>
                    {!directMode && (
                        <div className="mt-2 pt-2 border-t">
                             <a href="index.html" className="text-xs text-gray-400 hover:text-gray-600">Back to Home</a>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

function FaceVerification({ onVerified, student, testCode, onStreamAcquired }) {
    const videoRef = useRef(null);
    const [status, setStatus] = useState('camera_init'); 
    const [progress, setProgress] = useState(0);

    useEffect(() => {
        startCamera();
        return () => {
            // Cleanup logic if needed, but we want to keep stream alive
        }
    }, []);

    const startCamera = async () => {
        try {
            console.log("Requesting camera access...");
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            console.log("Camera access granted:", stream);
            
            if (videoRef.current) {
                videoRef.current.srcObject = stream;
            }
            onStreamAcquired(stream); // Pass up to App
            
            setStatus('scanning');
            startScanning();
            
            window.JRStorage.updateStudentStatus(student.regNumber, {
                name: student.name,
                regNumber: student.regNumber,
                testCode: testCode,
                status: 'Verifying',
                warningCount: 0
            });
        } catch (err) {
            console.error("Camera Error:", err);
            setStatus('failed');
        }
    };

    const startScanning = () => {
        let p = 0;
        // Slower scan for realism
        const interval = setInterval(() => {
            p += 1;
            setProgress(p);
            if (p >= 100) {
                clearInterval(interval);
                setStatus('verified');
                window.JRStorage.updateStudentStatus(student.regNumber, {
                    name: student.name,
                    regNumber: student.regNumber,
                    testCode: testCode,
                    status: 'Verified',
                    warningCount: 0
                });
                setTimeout(() => {
                    onVerified();
                }, 1500);
            }
        }, 60); 
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-900 text-white p-4">
            <div className="w-full max-w-lg text-center">
                <h2 className="text-2xl font-bold mb-6">AI Face Verification</h2>
                
                <div className="relative w-full aspect-square bg-black rounded-2xl overflow-hidden mb-6 border-4 border-gray-700 shadow-2xl bg-gray-800">
                    {(status === 'camera_init' || status === 'scanning' || status === 'verified') && (
                        <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover transform scale-x-[-1]"></video>
                    )}

                    {status === 'failed' && (
                        <div className="absolute inset-0 flex flex-col items-center justify-center p-6 bg-gray-800">
                            <div className="icon-camera-off text-4xl text-red-500 mb-4"></div>
                            <h3 className="text-xl font-bold">Camera Access Failed</h3>
                            <p className="text-sm mt-2">Please check browser permissions.</p>
                            <button onClick={startCamera} className="mt-4 bg-blue-600 px-6 py-2 rounded">Retry</button>
                        </div>
                    )}
                    
                    {(status === 'scanning' || status === 'verified') && (
                        <>
                            <div className="absolute inset-0 flex items-center justify-center">
                                <div className="w-64 h-64 border-2 border-white/30 rounded-full relative">
                                    {status === 'scanning' && <div className="scan-line"></div>}
                                    {status === 'verified' && (
                                        <div className="absolute inset-0 bg-emerald-500/20 flex items-center justify-center backdrop-blur-sm">
                                            <div className="bg-emerald-500 p-4 rounded-full">
                                                <div className="icon-check text-4xl text-white"></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="absolute bottom-0 left-0 w-full bg-black/60 p-4 text-sm font-mono">
                                <div className="flex justify-between mb-1">
                                    <span>Analysis Status:</span>
                                    <span className={status === 'verified' ? 'text-green-400' : 'text-yellow-400'}>{status.toUpperCase()}</span>
                                </div>
                                <div className="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden">
                                    <div className="h-full bg-green-500 transition-all duration-200" style={{width: `${progress}%`}}></div>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            </div>
        </div>
    );
}

function WaitingRoom({ test, onStart }) {
    const [timeLeft, setTimeLeft] = useState(0);

    useEffect(() => {
        const interval = setInterval(() => {
            const now = new Date();
            const start = new Date(test.startTime);
            const diff = start - now;

            if (diff <= 0) {
                clearInterval(interval);
                onStart();
            } else {
                setTimeLeft(diff);
            }
        }, 1000);
        return () => clearInterval(interval);
    }, []);

    const formatCountdown = (ms) => {
        const totalSeconds = Math.floor(ms / 1000);
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-900 text-white p-4">
            <div className="max-w-2xl w-full bg-gray-800 p-8 rounded-2xl shadow-2xl text-center border border-gray-700">
                <div className="w-20 h-20 mx-auto mb-6 bg-blue-900/30 rounded-full flex items-center justify-center animate-pulse">
                    <div className="icon-clock text-4xl text-blue-400"></div>
                </div>
                <h1 className="text-3xl font-bold mb-2">Waiting Room</h1>
                <p className="text-gray-400 mb-8">The test will commence automatically when the timer hits zero.</p>
                
                <div className="bg-black/50 p-8 rounded-xl border border-gray-600 mb-8">
                    <div className="text-sm text-gray-500 uppercase tracking-widest mb-2">Time Until Start</div>
                    <div className="text-6xl font-mono font-bold text-white tabular-nums">
                        {formatCountdown(timeLeft)}
                    </div>
                </div>

                <div className="text-left bg-gray-700/50 p-6 rounded-lg text-sm space-y-3">
                    <h3 className="font-bold text-gray-300 uppercase border-b border-gray-600 pb-2 mb-2">Instructions</h3>
                    <p>1. Do not refresh the page or you may be logged out.</p>
                    <p>2. Keep your face visible in the camera at all times.</p>
                    <p>3. Switching tabs is strictly prohibited and monitored.</p>
                    <p>4. Answer all questions before clicking Submit.</p>
                </div>
            </div>
        </div>
    );
}

function Exam({ student, test, directMode, cameraStream, onStreamRequest }) {
    // Determine initial time left based on Fixed Window or Duration
    // If student enters late, they should only have remaining time until EndTime
    const [timeLeft, setTimeLeft] = useState(() => {
        const now = new Date();
        const endTime = new Date(test.endTime);
        const durationSeconds = test.duration * 60;
        
        // Calculate seconds until absolute end time
        const secondsUntilEnd = Math.floor((endTime - now) / 1000);
        
        // Return whichever is smaller: the full duration, or time remaining in window
        // But also ensure it doesn't exceed the test duration if the window is huge
        // Actually, usually it's strict: Time Left = min(test_duration, window_remaining)
        
        return Math.min(durationSeconds, secondsUntilEnd);
    });

    const [activeSubject, setActiveSubject] = useState(0);
    const [answers, setAnswers] = useState({});
    const [isSubmitted, setIsSubmitted] = useState(false);
    const [warnings, setWarnings] = useState(0);
    const [messages, setMessages] = useState([]);
    
    // Live Camera Ref
    const miniVideoRef = useRef(null);
    const snapshotCanvasRef = useRef(null); // Invisible canvas for snapshots

    const [subjects] = useState(test.subjects.map(s => ({
        ...s,
        questions: s.questions || []
    })));

    // Camera Restoration Logic
    useEffect(() => {
        if (!cameraStream) {
            console.log("Exam component lost stream. Requesting restoration...");
            onStreamRequest();
        } else if (miniVideoRef.current) {
            console.log("Exam component attaching stream to video");
            miniVideoRef.current.srcObject = cameraStream;
            miniVideoRef.current.play().catch(e => console.log("Play error", e));
        }
    }, [cameraStream]);

    // Snapshot Logic
    useEffect(() => {
        const snapshotTimer = setInterval(() => {
            if (miniVideoRef.current && cameraStream) {
                const video = miniVideoRef.current;
                const canvas = snapshotCanvasRef.current;
                if(video.readyState === video.HAVE_ENOUGH_DATA) {
                     // Draw snapshot
                     const ctx = canvas.getContext('2d');
                     canvas.width = 160; 
                     canvas.height = 120;
                     ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                     // Low quality for speed
                     const dataUrl = canvas.toDataURL('image/jpeg', 0.3);

                     // Send to Admin frequently for movement effect
                     window.JRStorage.updateStudentStatus(student.regNumber, {
                        name: student.name,
                        regNumber: student.regNumber,
                        testCode: test.code,
                        status: 'Active',
                        warningCount: warnings,
                        snapshot: dataUrl,
                        lastSeen: new Date().toISOString()
                    });
                }
            }
        }, 1000); // 1s interval

        return () => clearInterval(snapshotTimer);
    }, [cameraStream, warnings]);

    useEffect(() => {
        const timer = setInterval(() => {
            setTimeLeft(prev => {
                if (prev <= 0) {
                    clearInterval(timer);
                    handleSubmit();
                    return 0;
                }
                return prev - 1;
            });
            checkMessages();
        }, 1000);

        const checkMessages = async () => {
             const msgs = await window.JRStorage.getMessages(student.regNumber);
             const newMsgs = msgs.filter(m => !m.read);
             if(newMsgs.length > 0) {
                 newMsgs.forEach(m => window.JRStorage.markMessageRead(m.id));
                 setMessages(prev => [...prev, ...newMsgs]);
             }
        }

        const handleVisibilityChange = () => {
            if (document.hidden) {
                setWarnings(w => w + 1);
                alert("WARNING: Tab switching is monitored! Return to test immediately.");
            }
        };
        document.addEventListener('visibilitychange', handleVisibilityChange);

        return () => {
            clearInterval(timer);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        };
    }, [warnings]);

    const handleAnswer = (qId, optionIdx) => {
        setAnswers(prev => ({
            ...prev,
            [`${activeSubject}-${qId}`]: optionIdx
        }));
    };

    const handleSubmit = async () => {
        // Calculate Score
        for (const sub of subjects) {
            let correctCount = 0;
            const totalQs = sub.questions.length;
            
            if(totalQs > 0) {
                sub.questions.forEach(q => {
                    if (answers[`${subjects.indexOf(sub)}-${q.id}`] === q.correct) {
                        correctCount++;
                    }
                });
                
                const score = Math.round((correctCount / totalQs) * 100);

                await window.JRStorage.saveResult({
                    studentId: student.regNumber,
                    studentName: student.name,
                    testId: test.id,
                    testCode: test.code,
                    subject: sub.name,
                    score: score, 
                    date: new Date().toISOString(),
                    approved: false
                });
            }
        }

        await window.JRStorage.updateStudentStatus(student.regNumber, {
            name: student.name,
            regNumber: student.regNumber,
            testCode: test.code,
            status: 'Completed',
            warningCount: warnings
        });

        setIsSubmitted(true);
    };

    if (isSubmitted) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="text-center bg-white p-12 rounded-2xl shadow-xl max-w-lg">
                    <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <div className="icon-check text-4xl text-green-600"></div>
                    </div>
                    <h2 className="text-3xl font-bold mb-4">Test Submitted!</h2>
                    <p className="text-gray-600 mb-8">Your responses have been securely recorded. <br/> Please wait for Admin approval to check results.</p>
                    {!directMode && (
                         <a href="index.html" className="inline-block bg-gray-900 text-white px-8 py-3 rounded-lg font-bold hover:bg-gray-800 transition-colors">
                             Return Home
                         </a>
                    )}
                </div>
            </div>
        );
    }

    const formatTime = (s) => {
        if(s <= 0) return "00:00";
        const mins = Math.floor(s / 60);
        const secs = s % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col">
            {/* Header */}
            <header className="bg-white shadow-sm border-b sticky top-0 z-10">
                <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                    <div className="flex items-center space-x-4">
                        <div className="bg-gray-100 p-2 rounded">
                            <span className="block text-xs text-gray-500">Student</span>
                            <span className="font-bold">{student.name}</span>
                        </div>
                        <div className="bg-gray-100 p-2 rounded">
                            <span className="block text-xs text-gray-500">Reg No</span>
                            <span className="font-mono">{student.regNumber}</span>
                        </div>
                    </div>
                    
                    <div className="text-2xl font-mono font-bold text-red-600 bg-red-50 px-4 py-2 rounded-lg border border-red-100 animate-pulse">
                        {formatTime(timeLeft)}
                    </div>

                    <button 
                        onClick={() => {
                            if(confirm("Submit Test? You cannot return.")) handleSubmit();
                        }}
                        className="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-emerald-700"
                    >
                        Submit Test
                    </button>
                </div>
            </header>

            {/* Messages Overlay */}
            {messages.length > 0 && (
                <div className="fixed top-24 right-4 z-50 w-80 space-y-2">
                    {messages.map((msg, idx) => (
                        <div key={idx} className="bg-blue-600 text-white p-4 rounded-lg shadow-lg flex items-start animate-bounce">
                             <div className="icon-message-circle mr-3 mt-1"></div>
                             <div>
                                 <h4 className="font-bold text-xs uppercase opacity-75">Admin Message</h4>
                                 <p className="text-sm">{msg.text}</p>
                             </div>
                        </div>
                    ))}
                </div>
            )}
            
            {/* PIP Camera Feed */}
            <div className="fixed bottom-4 right-4 z-40 w-48 bg-black rounded-lg overflow-hidden shadow-2xl border-2 border-emerald-500 group">
                <video ref={miniVideoRef} autoPlay playsInline muted className="w-full aspect-video object-cover transform scale-x-[-1]"></video>
                <div className="absolute top-1 left-2 flex items-center gap-1">
                    <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span className="text-[10px] text-white font-mono uppercase">Live Monitored</span>
                </div>
                {/* Hidden canvas for snapshot logic */}
                <canvas ref={snapshotCanvasRef} className="hidden"></canvas>
            </div>

            <div className="flex flex-1 max-w-7xl mx-auto w-full p-4 gap-6">
                {/* Subject Nav */}
                <div className="w-64 flex-shrink-0">
                    <div className="bg-white rounded-xl shadow-sm p-4 sticky top-24">
                        <h3 className="font-bold text-gray-500 text-sm uppercase tracking-wider mb-4">Subjects</h3>
                        <div className="space-y-2">
                            {subjects.map((sub, idx) => (
                                <button
                                    key={idx}
                                    onClick={() => setActiveSubject(idx)}
                                    className={`w-full text-left p-3 rounded-lg transition-all ${
                                        activeSubject === idx 
                                        ? 'bg-emerald-600 text-white shadow-md' 
                                        : 'bg-gray-50 text-gray-700 hover:bg-gray-100'
                                    }`}
                                >
                                    <span className="font-bold block">{sub.name}</span>
                                    <span className="text-xs opacity-75">{sub.questions.length} Questions</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Questions Area */}
                <div className="flex-1 bg-white rounded-xl shadow-sm p-8 min-h-[600px]">
                    <h2 className="text-2xl font-bold mb-6 border-b pb-4">{subjects[activeSubject].name}</h2>
                    
                    {subjects[activeSubject].questions.length === 0 ? (
                        <div className="text-center py-20 text-gray-400">
                            <div className="icon-file-question text-4xl mb-4"></div>
                            <p>No questions added for this subject.</p>
                        </div>
                    ) : (
                        <div className="space-y-8">
                            {subjects[activeSubject].questions.map((q, qIdx) => (
                                <div key={q.id} className="p-4 rounded-lg hover:bg-gray-50 transition-colors">
                                    <p className="font-medium text-lg mb-4 flex">
                                        <span className="text-gray-400 mr-2">{qIdx + 1}.</span>
                                        {q.text}
                                    </p>
                                    <div className="space-y-2 ml-8">
                                        {q.options.map((opt, optIdx) => {
                                            const isSelected = answers[`${activeSubject}-${q.id}`] === optIdx;
                                            return (
                                                <label key={optIdx} className={`flex items-center p-3 rounded border cursor-pointer transition-all ${
                                                    isSelected ? 'border-emerald-500 bg-emerald-50 ring-1 ring-emerald-500' : 'border-gray-200 hover:border-gray-300'
                                                }`}>
                                                    <input 
                                                        type="radio" 
                                                        name={`q-${activeSubject}-${q.id}`}
                                                        checked={isSelected}
                                                        onChange={() => handleAnswer(q.id, optIdx)}
                                                        className="mr-3 w-4 h-4 text-emerald-600"
                                                    />
                                                    {opt}
                                                </label>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

function App() {
    const [step, setStep] = useState('login'); 
    const [session, setSession] = useState({ student: null, test: null });
    const [cameraStream, setCameraStream] = useState(null);
    const [directMode] = useState(() => {
        const params = new URLSearchParams(window.location.search);
        return !!params.get('code');
    });

    const handleLogin = (student, test) => {
        setSession({ student, test });
        setStep('verify');
    };

    const handleVerified = () => {
        // Check if test has started
        const now = new Date();
        const start = new Date(session.test.startTime);
        
        if (now < start) {
            setStep('waiting');
        } else {
            setStep('exam');
        }
    };

    // Callback to restore stream if lost
    const restoreStream = async () => {
         try {
             console.log("App restoring stream...");
             const stream = await navigator.mediaDevices.getUserMedia({ video: true });
             setCameraStream(stream);
         } catch(e) {
             console.error("Failed to restore stream", e);
             alert("Camera access is required for monitoring!");
         }
    };

    return (
        <>
            {step === 'login' && <Login onLogin={handleLogin} directMode={directMode} />}
            {step === 'verify' && (
                <FaceVerification 
                    student={session.student} 
                    testCode={session.test?.code} 
                    onVerified={handleVerified} 
                    onStreamAcquired={setCameraStream} 
                />
            )}
            {step === 'waiting' && (
                <WaitingRoom 
                    test={session.test}
                    onStart={() => setStep('exam')}
                />
            )}
            {step === 'exam' && (
                <Exam 
                    student={session.student} 
                    test={session.test} 
                    directMode={directMode} 
                    cameraStream={cameraStream} 
                    onStreamRequest={restoreStream}
                />
            )}
        </>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);,
const { useState, useEffect } = React;

function ResultChecker() {
    const [regNumber, setRegNumber] = useState('');
    const [testCode, setTestCode] = useState('');
    const [results, setResults] = useState(null);
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const [studentInfo, setStudentInfo] = useState(null);
    const [accessClosed, setAccessClosed] = useState(false);

    // Check status first
    useEffect(() => {
        checkAccess();
    }, []);

    const checkAccess = async () => {
         const settings = await window.JRStorage.getSettings();
         if(settings.results_open === false) {
             setAccessClosed(true);
         } else {
             // Check query params
             const params = new URLSearchParams(window.location.search);
             const regParam = params.get('regNum');
             const codeParam = params.get('testCode');

             if(regParam) {
                 setRegNumber(regParam);
                 if(codeParam) {
                     setTestCode(codeParam);
                     setTimeout(() => performCheck(regParam, codeParam), 500);
                 }
             }
         }
    };

    const performCheck = async (reg, code) => {
        if(accessClosed) return;
        setLoading(true);
        setError('');
        try {
            const allResults = await window.JRStorage.getResults();
            // Filter: Match Reg, Match Code (if provided), AND MUST BE APPROVED
            const studentResults = allResults.filter(r => 
                r.studentId === reg && 
                (!code || r.testCode === code) &&
                r.approved === true
            );

            if (studentResults.length === 0) {
                setError('No approved results found. Please check details or contact admin.');
                setResults(null);
                setStudentInfo(null);
            } else {
                setResults(studentResults);
                
                // Fetch student info for photo/details
                const allStudents = await window.JRStorage.getStudents();
                const s = allStudents.find(st => st.regNumber === reg);
                setStudentInfo(s);
            }
        } catch (e) {
            setError('Error fetching results. Please try again.');
        }
        setLoading(false);
    };

    const handleCheck = (e) => {
        e.preventDefault();
        performCheck(regNumber, testCode);
    };

    const handlePrint = async () => {
        // Increment print count for records
        if(results && results.length > 0) {
            // Just update first record to track or loop all?
            // Let's update all associated with this print view
            for(const r of results) {
                 await window.JRStorage.update('result', r._id, { 
                     ...r, 
                     printedCount: (r.printedCount || 0) + 1 
                 });
            }
        }
        window.print();
    };

    if(accessClosed) {
        return (
            <div className="min-h-screen flex items-center justify-center p-4">
                <div className="bg-white p-8 rounded-xl shadow-lg text-center max-w-md w-full border border-red-100">
                    <div className="icon-lock text-4xl text-red-500 mx-auto mb-4"></div>
                    <h2 className="text-xl font-bold text-gray-900 mb-2">Portal Closed</h2>
                    <p className="text-gray-500">Result checking is currently unavailable. Please check back later.</p>
                </div>
            </div>
        )
    }

    return (
        <div className="min-h-screen py-12 px-4">
            {/* Checker Form */}
            {!results && (
                <div className="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-100">
                    <div className="text-center mb-8">
                         <div className="w-20 h-20 mx-auto mb-4 rounded-full overflow-hidden border-4 border-gray-100 shadow-lg">
                            <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-full h-full object-cover" />
                        </div>
                        <h1 className="text-2xl font-bold uppercase">Check Results</h1>
                        <p className="text-gray-500">JR NAGARA ONLINE TEST</p>
                    </div>

                    {error && (
                        <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm text-center">
                            {error}
                        </div>
                    )}

                    <form onSubmit={handleCheck} className="space-y-4">
                         <div>
                            <label className="block text-sm font-medium mb-1">Registration Number</label>
                            <input 
                                type="text" 
                                className="w-full p-3 border rounded outline-none focus:border-purple-600 transition-colors"
                                value={regNumber}
                                onChange={e => setRegNumber(e.target.value)}
                                placeholder="e.g. JR2026..."
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Test Code</label>
                            <input 
                                type="text" 
                                className="w-full p-3 border rounded outline-none focus:border-purple-600 transition-colors"
                                value={testCode}
                                onChange={e => setTestCode(e.target.value)}
                                placeholder="e.g. 2026-MOCK..."
                                required
                            />
                        </div>
                        <button disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded font-bold hover:bg-purple-700 transition-colors disabled:opacity-50">
                            {loading ? 'Checking...' : 'Check Result'}
                        </button>
                    </form>
                </div>
            )}

            {/* Result Slip View */}
            {results && (
                <div className="max-w-3xl mx-auto">
                    <div className="mb-4 flex justify-end items-center no-print gap-4">
                        <button onClick={() => setResults(null)} className="text-gray-500 hover:text-black">
                             Check Another
                        </button>
                        <button onClick={handlePrint} className="bg-purple-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-purple-700">
                            <div className="icon-printer"></div> Print Result Slip
                        </button>
                    </div>

                    <div className="bg-white p-10 rounded shadow-none border-2 border-gray-900 result-slip relative overflow-hidden">
                        {/* Logo Watermark Full BG */}
                        <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none z-0">
                            <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-[70%] h-[70%] object-contain" />
                        </div>

                        {/* Header */}
                        <div className="border-b-4 border-gray-900 pb-6 mb-6 flex items-center gap-6 relative z-10">
                             <div className="w-24 h-24 flex-shrink-0">
                                <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-full h-full object-cover" />
                            </div>
                            <div className="flex-1">
                                <h1 className="text-3xl font-black text-gray-900 tracking-tight uppercase">JR NAGARA ONLINE TEST</h1>
                                <p className="text-sm font-bold tracking-widest uppercase text-purple-800">Statement of Result - UTME PRACTICE</p>
                            </div>
                            <div className="text-right">
                                <div className="w-28 h-28 bg-gray-100 border-2 border-gray-300 flex items-center justify-center overflow-hidden rounded">
                                     {studentInfo && studentInfo.passport ? (
                                         <img src={studentInfo.passport} className="w-full h-full object-cover" />
                                     ) : (
                                         <span className="text-xs text-gray-400">Passport</span>
                                     )}
                                </div>
                            </div>
                        </div>

                        {/* Student Details */}
                        <div className="grid grid-cols-2 gap-y-4 gap-x-12 mb-8 text-sm border-b-2 border-gray-200 pb-8">
                            <div className="flex justify-between border-b border-gray-100 pb-1">
                                <span className="text-gray-500 font-bold">Candidate Name</span>
                                <span className="font-bold uppercase">{studentInfo ? studentInfo.name : results[0].studentName}</span>
                            </div>
                             <div className="flex justify-between border-b border-gray-100 pb-1">
                                <span className="text-gray-500 font-bold">Registration No</span>
                                <span className="font-mono font-bold text-lg">{results[0].studentId}</span>
                            </div>
                             <div className="flex justify-between border-b border-gray-100 pb-1">
                                <span className="text-gray-500 font-bold">Examination</span>
                                <span className="font-bold">{results[0].testCode}</span>
                            </div>
                             <div className="flex justify-between border-b border-gray-100 pb-1">
                                <span className="text-gray-500 font-bold">Date</span>
                                <span className="font-bold">{new Date().toLocaleDateString()}</span>
                            </div>
                        </div>

                        {/* Scores Table */}
                        <div className="mb-8">
                            <h3 className="font-bold text-lg mb-4 uppercase tracking-wide border-l-4 border-purple-600 pl-3">Performance Detail</h3>
                            <table className="w-full border-collapse border border-gray-900">
                                <thead className="bg-gray-900 text-white">
                                    <tr>
                                        <th className="p-3 text-left border border-gray-700">Subject</th>
                                        <th className="p-3 text-right border border-gray-700 w-32">Score Obtained</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {results.map((r, i) => (
                                        <tr key={i} className="border-b border-gray-300">
                                            <td className="p-3 border-r border-gray-300 font-medium">{r.subject}</td>
                                            <td className="p-3 text-right font-mono font-bold">{r.score}</td>
                                        </tr>
                                    ))}
                                    <tr className="bg-purple-50">
                                        <td className="p-3 border-r border-purple-200 font-bold text-right uppercase">Aggregate Score</td>
                                        <td className="p-3 text-right font-bold text-xl">{results.reduce((acc, curr) => acc + curr.score, 0)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        {/* Footer */}
                        <div className="flex justify-between items-end mt-16 pt-8 border-t-2 border-gray-900 relative z-10">
                            <div className="text-xs text-gray-500">
                                <p>1. This result slip is generated electronically.</p>
                                <p>2. Any alteration renders this document invalid.</p>
                                <p>3. STRICTLY NO COPYING OR REMIXING ALLOWED.</p>
                                <p className="font-mono mt-2">ID: {Math.random().toString(36).substr(2, 12).toUpperCase()}</p>
                            </div>
                            <div className="text-center flex flex-col items-center">
                                <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/dcdc53cf-300a-4a1e-9e12-6c79d91896af.jpeg" className="h-16 object-contain -mb-4" />
                                <div className="w-40 border-b border-gray-900 mb-1"></div>
                                <p className="text-xs font-bold uppercase">REGISTRAR</p>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ResultChecker />);,
const { useState, useEffect, useRef } = React;

// Image Compression Utility
const compressImage = (file) => {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600; // Resize to max 600px width
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Compress to JPEG 0.7
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    });
};

const AVAILABLE_SUBJECTS = [
    'Mathematics', 'English Language', 'Physics', 'Chemistry', 'Biology', 
    'Economics', 'Government', 'Literature', 'CRS', 'IRS', 'History', 
    'Geography', 'Accounting', 'Commerce'
];

function RegistrationApp() {
    const [activeTab, setActiveTab] = useState('register'); // register, recover, slip
    const [registrationOpen, setRegistrationOpen] = useState(true);
    
    // Registration Form State
    const [formData, setFormData] = useState({
        fullName: '',
        email: '',
        phone: '',
        address: '',
        stateOrigin: '',
        lga: '',
        department: '',
        selectedSubjects: [],
        passport: null
    });
    const [regLoading, setRegLoading] = useState(false);
    const [generatedStudent, setGeneratedStudent] = useState(null);
    const [regError, setRegError] = useState('');
    const fileInputRef = useRef(null);

    // Recover/Slip State
    const [searchQuery, setSearchQuery] = useState(''); // RegNo or Phone
    const [foundStudent, setFoundStudent] = useState(null);
    const [foundTest, setFoundTest] = useState(null); // For Exam Slip
    const [searchLoading, setSearchLoading] = useState(false);
    const [searchError, setSearchError] = useState('');

    useEffect(() => {
        checkStatus();
    }, []);

    const checkStatus = async () => {
        const settings = await window.JRStorage.getSettings();
        setRegistrationOpen(settings.registration_open !== false);
    };

    // --- REGISTRATION HANDLERS ---
    const handleFileChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                const compressed = await compressImage(file);
                setFormData(prev => ({ ...prev, passport: compressed }));
            } catch (e) {
                alert("Error processing image. Please try another.");
            }
        }
    };

    const handleSubjectToggle = (subj) => {
        const current = [...formData.selectedSubjects];
        if (current.includes(subj)) {
            setFormData(prev => ({ ...prev, selectedSubjects: current.filter(s => s !== subj) }));
        } else {
            if (current.length >= 4) {
                alert("You can select maximum 4 subjects.");
                return;
            }
            setFormData(prev => ({ ...prev, selectedSubjects: [...current, subj] }));
        }
    }

    const handleRegister = async (e) => {
        e.preventDefault();
        setRegError('');
        setRegLoading(true);

        if (!formData.passport) {
            setRegError("Passport photograph is required.");
            setRegLoading(false);
            return;
        }

        if (formData.selectedSubjects.length < 3) {
             setRegError("Please select at least 3 subjects.");
             setRegLoading(false);
             return;
        }

        try {
            const students = await window.JRStorage.getStudents();
            const duplicate = students.find(s => 
                (s.email && s.email.toLowerCase() === formData.email.toLowerCase()) || 
                (s.phone && s.phone === formData.phone)
            );

            if (duplicate) {
                setRegError(`Student already registered (Reg No: ${duplicate.regNumber}). Please use the 'Recover' tab.`);
                setRegLoading(false);
                return;
            }

            const year = new Date().getFullYear();
            const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            const regNumber = `JR${year}${randomNum}`;

            const newStudent = {
                id: 'ST-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                name: formData.fullName,
                regNumber: regNumber,
                email: formData.email,
                phone: formData.phone,
                address: formData.address,
                stateOrigin: formData.stateOrigin,
                lga: formData.lga,
                department: formData.department,
                selectedSubjects: formData.selectedSubjects,
                passport: formData.passport,
                registeredAt: new Date().toISOString()
            };

            await window.JRStorage.saveStudent(newStudent);
            setGeneratedStudent(newStudent);
        } catch (err) {
            setRegError("System error during registration. Please try resizing your photo or try again later.");
            console.error(err);
        }
        setRegLoading(false);
    };

    // --- RECOVER / SLIP HANDLERS ---
    const handleSearch = async (type) => { 
        setSearchLoading(true);
        setSearchError('');
        setFoundStudent(null);
        setFoundTest(null);

        try {
            const students = await window.JRStorage.getStudents();
            const student = students.find(s => 
                s.regNumber === searchQuery || 
                s.phone === searchQuery || 
                (s.email && s.email.toLowerCase() === searchQuery.toLowerCase())
            );

            if (!student) {
                setSearchError('No student record found with these details.');
            } else {
                setFoundStudent(student);
                if (type === 'slip') {
                    const tests = await window.JRStorage.getTests();
                    const assignedTest = tests.find(t => 
                        t.assignedStudents && t.assignedStudents.includes(student.regNumber)
                    );
                    
                    if (assignedTest) {
                        setFoundTest(assignedTest);
                    } else {
                        setSearchError('You have not been assigned to any specific test schedule yet.');
                        setFoundStudent(null); 
                    }
                }
            }
        } catch (e) {
            setSearchError('Error searching records.');
        }
        setSearchLoading(false);
    };

    // --- RENDER ---
    const renderNav = () => (
        <div className="flex justify-center mb-8 bg-white p-1 rounded-xl shadow-sm border border-gray-100 no-print">
            {[
                { id: 'register', label: 'New Registration', icon: 'icon-user-plus' },
                { id: 'recover', label: 'Recover Reg No', icon: 'icon-search' },
                { id: 'slip', label: 'Print Exam Slip', icon: 'icon-printer' }
            ].map(tab => (
                <button
                    key={tab.id}
                    onClick={() => { setActiveTab(tab.id); setGeneratedStudent(null); setFoundStudent(null); setSearchQuery(''); setRegError(''); setSearchError(''); }}
                    className={`flex items-center space-x-2 px-6 py-3 rounded-lg font-bold transition-all ${
                        activeTab === tab.id 
                        ? 'bg-emerald-600 text-white shadow-md' 
                        : 'text-gray-500 hover:bg-gray-50'
                    }`}
                >
                    <div className={tab.icon}></div>
                    <span className="hidden md:inline">{tab.label}</span>
                </button>
            ))}
        </div>
    );

    if (generatedStudent) {
        return (
            <div className="min-h-screen py-12 px-4 flex flex-col items-center bg-gray-50">
                <div className="w-full max-w-2xl mb-6 flex justify-between items-center no-print">
                    <button onClick={() => setGeneratedStudent(null)} className="text-gray-600 flex items-center gap-2 hover:text-black">
                        <div className="icon-arrow-left"></div> Back
                    </button>
                    <button onClick={() => window.print()} className="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-emerald-700">
                        <div className="icon-printer"></div> Print Slip
                    </button>
                </div>
                <RegistrationSlip student={generatedStudent} title="Registration Confirmation" />
            </div>
        );
    }

    if (activeTab === 'slip' && foundStudent && foundTest) {
         return (
            <div className="min-h-screen py-12 px-4 flex flex-col items-center bg-gray-50">
                <div className="w-full max-w-2xl mb-6 flex justify-between items-center no-print">
                    <button onClick={() => { setFoundStudent(null); setFoundTest(null); }} className="text-gray-600 flex items-center gap-2 hover:text-black">
                        <div className="icon-arrow-left"></div> Back
                    </button>
                    <button onClick={() => window.print()} className="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-emerald-700">
                        <div className="icon-printer"></div> Print Exam Slip
                    </button>
                </div>
                <ExamScheduleSlip student={foundStudent} test={foundTest} />
            </div>
        );
    }

    return (
        <div className="min-h-screen py-8 px-4 flex flex-col items-center bg-gray-50">
            {renderNav()}

            <div className="w-full max-w-2xl bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                {activeTab === 'register' && (
                    <>
                        <div className="text-center mb-8">
                             <div className="w-16 h-16 mx-auto mb-2 rounded-lg overflow-hidden">
                                 <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-full h-full object-cover" />
                             </div>
                            <h2 className="text-2xl font-bold text-gray-900 uppercase">JR NAGARA ONLINE TEST</h2>
                            <p className="text-gray-500">Candidate Registration Portal</p>
                        </div>

                        {!registrationOpen ? (
                            <div className="text-center p-8 bg-red-50 rounded-xl">
                                <div className="icon-lock text-4xl text-red-500 mx-auto mb-2"></div>
                                <h3 className="font-bold text-red-700">Registration Closed</h3>
                                <p className="text-sm text-red-600">Contact Admin for support.</p>
                            </div>
                        ) : (
                            <form onSubmit={handleRegister} className="space-y-6">
                                {regError && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{regError}</div>}
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="col-span-1 md:col-span-2">
                                        <label className="block text-sm font-bold mb-1">Full Name</label>
                                        <input required name="fullName" value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value})} className="w-full p-3 border rounded-lg" placeholder="Surname Firstname" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-1">Email</label>
                                        <input required type="email" name="email" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="w-full p-3 border rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-1">Phone</label>
                                        <input required type="tel" name="phone" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} className="w-full p-3 border rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-1">State of Origin</label>
                                        <input required name="stateOrigin" value={formData.stateOrigin} onChange={e => setFormData({...formData, stateOrigin: e.target.value})} className="w-full p-3 border rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-1">LGA</label>
                                        <input required name="lga" value={formData.lga} onChange={e => setFormData({...formData, lga: e.target.value})} className="w-full p-3 border rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-1">Department</label>
                                        <select required className="w-full p-3 border rounded-lg" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})}>
                                            <option value="">Select Department</option>
                                            <option value="Science">Science</option>
                                            <option value="Art">Art</option>
                                            <option value="Commercial">Commercial</option>
                                        </select>
                                    </div>
                                    <div className="col-span-1 md:col-span-2">
                                        <label className="block text-sm font-bold mb-2">Subject Selection (Max 4)</label>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            {AVAILABLE_SUBJECTS.map(subj => (
                                                <div 
                                                    key={subj}
                                                    onClick={() => handleSubjectToggle(subj)}
                                                    className={`p-2 rounded border text-xs cursor-pointer select-none transition-all ${
                                                        formData.selectedSubjects.includes(subj) 
                                                        ? 'bg-emerald-600 text-white border-emerald-600' 
                                                        : 'bg-white text-gray-600 hover:border-emerald-400'
                                                    }`}
                                                >
                                                    {subj}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="col-span-1 md:col-span-2">
                                        <label className="block text-sm font-bold mb-1">Address</label>
                                        <textarea required name="address" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} className="w-full p-3 border rounded-lg h-20"></textarea>
                                    </div>
                                    <div className="col-span-1 md:col-span-2">
                                        <label className="block text-sm font-bold mb-1">Passport Photo</label>
                                        <div onClick={() => fileInputRef.current.click()} className="border-2 border-dashed border-gray-300 p-4 text-center rounded-lg cursor-pointer hover:bg-gray-50">
                                            {formData.passport ? (
                                                <img src={formData.passport} className="h-24 w-24 object-cover rounded-full mx-auto" />
                                            ) : (
                                                <div className="text-gray-500">
                                                    <div className="icon-camera text-2xl mb-1"></div>
                                                    <span>Click to upload</span>
                                                </div>
                                            )}
                                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                                        </div>
                                    </div>
                                </div>

                                <button disabled={regLoading} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700 disabled:opacity-50">
                                    {regLoading ? 'Registering...' : 'Complete Registration'}
                                </button>
                            </form>
                        )}
                    </>
                )}

                {activeTab === 'recover' && (
                    <div className="space-y-6">
                        <div className="text-center">
                            <h2 className="text-2xl font-bold text-gray-900">Recover Registration</h2>
                            <p className="text-gray-500">Find your registration details.</p>
                        </div>
                        
                        {searchError && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{searchError}</div>}
                        
                        {!foundStudent ? (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold mb-1">Enter Phone Number or Email</label>
                                    <input 
                                        type="text" 
                                        value={searchQuery}
                                        onChange={e => setSearchQuery(e.target.value)}
                                        className="w-full p-3 border rounded-lg"
                                        placeholder="e.g. 08012345678"
                                    />
                                </div>
                                <button onClick={() => handleSearch('recover')} disabled={searchLoading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">
                                    {searchLoading ? 'Searching...' : 'Find Record'}
                                </button>
                            </div>
                        ) : (
                            <div className="text-center">
                                <div className="w-20 h-20 bg-gray-200 rounded-full mx-auto overflow-hidden mb-4">
                                    <img src={foundStudent.passport} className="w-full h-full object-cover" />
                                </div>
                                <h3 className="text-xl font-bold">{foundStudent.name}</h3>
                                <p className="text-2xl font-mono text-emerald-600 font-bold my-2">{foundStudent.regNumber}</p>
                                <p className="text-gray-500 text-sm mb-6">Keep this number safe!</p>
                                <button onClick={() => setGeneratedStudent(foundStudent)} className="text-blue-600 underline">Print Registration Slip</button>
                            </div>
                        )}
                    </div>
                )}

                {activeTab === 'slip' && (
                    <div className="space-y-6">
                         <div className="text-center">
                            <h2 className="text-2xl font-bold text-gray-900">Print Assignment Slip</h2>
                            <p className="text-gray-500">Check if you have been scheduled for a test.</p>
                        </div>

                         {searchError && <div className="bg-red-50 text-red-600 p-3 rounded text-sm">{searchError}</div>}

                         <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold mb-1">Enter Registration Number</label>
                                <input 
                                    type="text" 
                                    value={searchQuery}
                                    onChange={e => setSearchQuery(e.target.value)}
                                    className="w-full p-3 border rounded-lg font-mono"
                                    placeholder="e.g. JR2026..."
                                />
                            </div>
                            <button onClick={() => handleSearch('slip')} disabled={searchLoading} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold">
                                {searchLoading ? 'Checking Schedule...' : 'View Exam Schedule'}
                            </button>
                        </div>
                    </div>
                )}
            </div>
            
            <div className="mt-8 text-center text-gray-400 text-sm no-print">
                 &copy; 2026 JR NAGARA ONLINE TEST
            </div>
        </div>
    );
}

// Sub-Component: Registration Slip
function RegistrationSlip({ student, title }) {
    return (
        <div className="bg-white p-10 rounded-xl shadow-lg border-2 border-gray-900 w-full max-w-2xl relative overflow-hidden">
             {/* Badge Background Watermark */}
             <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-[70%] h-[70%] object-contain" />
            </div>
            <div className="flex justify-between items-start border-b-2 border-gray-900 pb-6 mb-8 relative z-10">
                <div>
                    <h1 className="text-2xl font-black text-gray-900 uppercase">JR NAGARA ONLINE TEST</h1>
                    <p className="text-sm font-bold tracking-widest uppercase mt-1 text-emerald-700">{title}</p>
                </div>
                <div className="text-right">
                    <p className="text-xs text-gray-500 mb-1">Date</p>
                    <p className="font-mono font-bold">{new Date().toLocaleDateString()}</p>
                </div>
            </div>
            <div className="flex gap-8 mb-8 relative z-10">
                <div className="w-32 h-32 bg-gray-100 border-2 border-gray-300 flex-shrink-0 flex items-center justify-center overflow-hidden rounded-md">
                    <img src={student.passport} className="w-full h-full object-cover" />
                </div>
                <div className="flex-1 grid grid-cols-2 gap-y-4 gap-x-8 text-sm">
                    <div><span className="block text-gray-500 text-xs">Full Name</span><span className="font-bold text-lg">{student.name}</span></div>
                    <div><span className="block text-gray-500 text-xs">Reg Number</span><span className="font-mono font-bold text-xl text-emerald-700">{student.regNumber}</span></div>
                    <div><span className="block text-gray-500 text-xs">Department</span><span className="font-medium">{student.department || 'N/A'}</span></div>
                    <div><span className="block text-gray-500 text-xs">State/LGA</span><span className="font-medium">{student.stateOrigin} / {student.lga}</span></div>
                    <div><span className="block text-gray-500 text-xs">Phone</span><span className="font-medium">{student.phone}</span></div>
                    <div className="col-span-2"><span className="block text-gray-500 text-xs">Subjects</span><span className="font-medium">{student.selectedSubjects ? student.selectedSubjects.join(', ') : 'None'}</span></div>
                </div>
            </div>
            <div className="flex justify-between items-end mt-8 relative z-10">
                <div className="bg-gray-50 p-4 rounded border border-gray-200 text-sm max-w-sm">
                    <h3 className="font-bold text-xs uppercase mb-1">Important</h3>
                    <p>This slip is required for entry into the exam hall. Do not share your Registration Number.</p>
                </div>
                 <div className="text-center flex flex-col items-center">
                    <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/206d87e6-a830-431d-8b3e-363a27218dad.jpeg" className="h-14 object-contain -mb-3" />
                    <div className="w-32 border-b border-gray-900 mb-1"></div>
                    <p className="text-[10px] font-bold uppercase">REGISTRAR</p>
                </div>
            </div>
        </div>
    );
}

// Sub-Component: Exam Schedule Slip
function ExamScheduleSlip({ student, test }) {
    const link = `${window.location.origin}/student.html?code=${test.code}`;
    
    return (
        <div className="bg-white p-10 rounded-xl shadow-lg border-2 border-gray-900 w-full max-w-2xl relative overflow-hidden">
            <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/49d92f14-334d-4dff-a9ad-044794e4b6cd.jpeg" className="w-[70%] h-[70%] object-contain" />
            </div>
            <div className="flex justify-between items-start border-b-2 border-gray-900 pb-6 mb-8 relative z-10">
                <div>
                    <h1 className="text-2xl font-black text-gray-900 uppercase">JR NAGARA ONLINE TEST</h1>
                    <p className="text-sm font-bold tracking-widest uppercase mt-1 text-purple-700">Examination Schedule Slip</p>
                </div>
                 <div className="text-right">
                    <div className="w-20 h-20 bg-gray-100 rounded overflow-hidden border border-gray-300">
                         <img src={student.passport} className="w-full h-full object-cover" />
                    </div>
                </div>
            </div>

            <div className="mb-8 relative z-10">
                <div className="grid grid-cols-2 gap-4 mb-6">
                    <div className="bg-gray-50 p-3 rounded">
                        <span className="block text-xs text-gray-500">Candidate Name</span>
                        <span className="font-bold">{student.name}</span>
                    </div>
                    <div className="bg-gray-50 p-3 rounded">
                         <span className="block text-xs text-gray-500">Registration Number</span>
                        <span className="font-bold font-mono">{student.regNumber}</span>
                    </div>
                </div>

                <div className="border border-gray-200 rounded-lg p-6">
                    <h3 className="font-bold text-lg mb-4 text-center border-b pb-2">Examination Details</h3>
                    <div className="grid grid-cols-2 gap-y-4 text-sm">
                        <div>
                            <span className="text-gray-500 block text-xs">Test Title</span>
                            <span className="font-bold">{test.title}</span>
                        </div>
                         <div>
                            <span className="text-gray-500 block text-xs">Test Code</span>
                            <span className="font-bold font-mono">{test.code}</span>
                        </div>
                        <div>
                            <span className="text-gray-500 block text-xs">Start Time</span>
                            <span className="font-bold">{new Date(test.startTime).toLocaleString()}</span>
                        </div>
                         <div>
                            <span className="text-gray-500 block text-xs">End Time</span>
                            <span className="font-bold">{new Date(test.endTime).toLocaleString()}</span>
                        </div>
                         <div>
                            <span className="text-gray-500 block text-xs">Duration</span>
                            <span className="font-bold">{test.duration} Minutes</span>
                        </div>
                        <div>
                            <span className="text-gray-500 block text-xs">Subjects</span>
                            <span className="font-bold">{test.subjects.map(s => s.name).join(', ')}</span>
                        </div>
                    </div>
                    
                    <div className="mt-6 bg-yellow-50 p-4 rounded border border-yellow-200">
                        <span className="block text-xs text-gray-500 font-bold mb-1">Access Link</span>
                        <div className="font-mono text-sm break-all">{link}</div>
                    </div>
                </div>
            </div>

            <div className="flex justify-between items-end mt-4 relative z-10">
                <div className="text-xs text-gray-400">
                    <p>Printed on {new Date().toLocaleString()}</p>
                    <p>No Copying Allowed.</p>
                </div>
                 <div className="text-center flex flex-col items-center">
                    <img src="https://app.trickle.so/storage/public/images/usr_1a4d0bc2f0000001/206d87e6-a830-431d-8b3e-363a27218dad.jpeg" className="h-14 object-contain -mb-3" />
                    <div className="w-32 border-b border-gray-900 mb-1"></div>
                    <p className="text-[10px] font-bold uppercase">REGISTRAR</p>
                </div>
            </div>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<RegistrationApp />);